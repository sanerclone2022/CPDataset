[{"authorTime":"2019-11-08 09:46:59","codes":[{"authorDate":"2019-11-08 09:46:59","commitOrder":2,"curCode":"  public void testNoStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringFirstAggregatorFactory factory = new StringFirstAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringFirstBufferAggregator agg = new StringFirstBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","date":"2019-11-08 09:46:59","endLine":156,"groupId":"20667","id":1,"instanceNumber":1,"isCurCommit":0,"methodName":"testNoStringValue","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-druid-10-0.7/blobInfo/CC_OUT/blobs/04/700fae42dfb8847708869a67c62e80e786a901.src","preCode":"  public void testNoStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringFirstAggregatorFactory factory = new StringFirstAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringFirstBufferAggregator agg = new StringFirstBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","realPath":"processing/src/test/java/org/apache/druid/query/aggregation/first/StringFirstBufferAggregatorTest.java","repoName":"druid","snippetEndLine":0,"snippetStartLine":0,"startLine":123,"status":"MB"},{"authorDate":"2019-11-08 09:46:59","commitOrder":2,"curCode":"  public void testNonStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringLastAggregatorFactory factory = new StringLastAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringLastBufferAggregator agg = new StringLastBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","date":"2019-11-08 09:46:59","endLine":156,"groupId":"20667","id":2,"instanceNumber":2,"isCurCommit":0,"methodName":"testNonStringValue","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-druid-10-0.7/blobInfo/CC_OUT/blobs/18/a378855a6f16c15bf1cc7caf9ba1ebe21a1616.src","preCode":"  public void testNonStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringLastAggregatorFactory factory = new StringLastAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringLastBufferAggregator agg = new StringLastBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","realPath":"processing/src/test/java/org/apache/druid/query/aggregation/last/StringLastBufferAggregatorTest.java","repoName":"druid","snippetEndLine":0,"snippetStartLine":0,"startLine":123,"status":"B"}],"commitId":"c204d6837613ef2a36eb093707e66db78407311b","commitMessage":"@@@Fixes.  adjustments to numeric null handling and string first/last aggregators. (#8834)\n\nThere is a class of bugs due to the fact that BaseObjectColumnValueSelector\nhas both \"getObject\" and \"isNull\" methods.  but in most selector implementations\nand most call sites.  it is clear that the intent of \"isNull\" is only to apply\nto the primitive getters.  not the object getter. This makes sense.  because the\npurpose of isNull is to enable detection of nulls in otherwise-primitive columns.\nImagine a string column with a numeric selector built on top of it. You would\nwant it to return isNull = true.  so numeric aggregators don't treat it as\nall zeroes.\n\nSometimes this design leads people to accidentally guard non-primitive get\nmethods with \"selector.isNull\" checks.  which is improper.\n\nThis patch has three goals:\n\n1) Fix null-handling bugs that already exist in this class.\n2) Make interface and doc changes that reduce the probability of future bugs.\n3) Fix other.  unrelated bugs I noticed in the stringFirst and stringLast\n   aggregators while fixing null-handling bugs. I thought about splitting this\n   into its own patch.  but it ended up being tough to split from the\n   null-handling fixes.\n\nFor (1) the fixes are. \n\n- Fix StringFirst and StringLastAggregatorFactory to stop guarding getObject\n  calls on isNull.  by no longer extending NullableAggregatorFactory. Now uses\n  -1 as a sigil value for null.  to differentiate nulls and empty strings.\n- Fix ExpressionFilter to stop guarding getObject calls on isNull. Also.  use\n  eval.asBoolean() to avoid calling getLong on the selector after already\n  calling getObject.\n- Fix ObjectBloomFilterAggregator to stop guarding DimensionSelector calls\n  on isNull. Also.  refactored slightly to avoid the overhead of calling\n  getObject followed by another getter (see BloomFilterAggregatorFactory for\n  part of this).\n\nFor (2) the main changes are. \n\n- Remove the \"isNull\" method from BaseObjectColumnValueSelector.\n- Clarify \"isNull\" doc on BaseNullableColumnValueSelector.\n- Rename NullableAggregatorFactory -> NullbleNumericAggregatorFactory to emphasize\n  that it only works on aggregators that take numbers as input.\n- Similar naming changes to the Aggregator.  BufferAggregator.  and AggregateCombiner.\n- Similar naming changes to helper methods for groupBy.  ValueMatchers.  etc.\n\nFor (3) the other fixes for StringFirst and StringLastAggregatorFactory are. \n\n- Fixed buffer overrun in the buffer aggregators when some characters in the string\n  code into more than one byte (the old code used \"substring\" to apply a byte limit. \n  which is bad). I did this by introducing a new StringUtils.toUtf8WithLimit method.\n- Fixed weird IncrementalIndex logic that led to reading nulls for the timestamp.\n- Adjusted weird StringFirst/Last logic that worked around the weird IncrementalIndex\n  behavior.\n- Refactored to share code between the four aggregators.\n- Improved test coverage.\n- Made the base stringFirst.  stringLast aggregators adaptive.  and streamlined the\n  xFold versions into aliases. The adaptiveness is similar to how other aggregators\n  like hyperUnique work.","date":"2019-11-08 09:46:59","modifiedFileCount":"45","status":"M","submitter":"Gian Merlino"},{"authorTime":"2020-01-17 13:02:02","codes":[{"authorDate":"2020-01-17 13:02:02","commitOrder":3,"curCode":"  public void testNoStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringFirstAggregatorFactory factory = new StringFirstAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringFirstBufferAggregator agg = new StringFirstBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes,\n        false\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","date":"2020-01-17 13:02:02","endLine":194,"groupId":"6564","id":3,"instanceNumber":1,"isCurCommit":0,"methodName":"testNoStringValue","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-druid-10-0.7/blobInfo/CC_OUT/blobs/3b/4ef692bf5238c53369a22a299cbc3a5c4e8efa.src","preCode":"  public void testNoStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringFirstAggregatorFactory factory = new StringFirstAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringFirstBufferAggregator agg = new StringFirstBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","realPath":"processing/src/test/java/org/apache/druid/query/aggregation/first/StringFirstBufferAggregatorTest.java","repoName":"druid","snippetEndLine":0,"snippetStartLine":0,"startLine":160,"status":"M"},{"authorDate":"2020-01-17 13:02:02","commitOrder":3,"curCode":"  public void testNonStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringLastAggregatorFactory factory = new StringLastAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringLastBufferAggregator agg = new StringLastBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes,\n        false\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","date":"2020-01-17 13:02:02","endLine":196,"groupId":"6564","id":4,"instanceNumber":2,"isCurCommit":0,"methodName":"testNonStringValue","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-druid-10-0.7/blobInfo/CC_OUT/blobs/6c/350c4cff1eb8dcceead40874aaafe0e20b9138.src","preCode":"  public void testNonStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringLastAggregatorFactory factory = new StringLastAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringLastBufferAggregator agg = new StringLastBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","realPath":"processing/src/test/java/org/apache/druid/query/aggregation/last/StringLastBufferAggregatorTest.java","repoName":"druid","snippetEndLine":0,"snippetStartLine":0,"startLine":162,"status":"M"}],"commitId":"448da787654ef6ebcab7bb5cba340b931c454320","commitMessage":"@@@Speed up String first/last aggregators when folding isn't needed. (#9181)\n\n* Speed up String first/last aggregators when folding isn't needed.\n\nExamines the value column.  and disables fold checking via a needsFoldCheck\nflag if that column can't possibly contain SerializableLongStringPairs. This\nis helpful because it avoids calling getObject on the value selector when\nunnecessary; say.  because the time selector didn't yield an earlier or later\nvalue.\n\n* PR comments.\n\n* Move fastLooseChop to StringUtils.\n","date":"2020-01-17 13:02:02","modifiedFileCount":"13","status":"M","submitter":"Gian Merlino"},{"authorTime":"2020-01-17 13:02:02","codes":[{"authorDate":"2020-01-21 03:51:54","commitOrder":4,"curCode":"  public void testNoStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringFirstAggregatorFactory factory = new StringFirstAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringFirstBufferAggregator agg = new StringFirstBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes,\n        false\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724000L, (long) sp.lhs);\n    Assert.assertEquals(null, sp.rhs);\n  }\n","date":"2020-01-21 03:51:54","endLine":194,"groupId":"107029","id":5,"instanceNumber":1,"isCurCommit":0,"methodName":"testNoStringValue","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-druid-10-0.7/blobInfo/CC_OUT/blobs/8d/88677bb55b218faa6fdb57b52ad7b5896c69ae.src","preCode":"  public void testNoStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringFirstAggregatorFactory factory = new StringFirstAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringFirstBufferAggregator agg = new StringFirstBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes,\n        false\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","realPath":"processing/src/test/java/org/apache/druid/query/aggregation/first/StringFirstBufferAggregatorTest.java","repoName":"druid","snippetEndLine":0,"snippetStartLine":0,"startLine":160,"status":"M"},{"authorDate":"2020-01-17 13:02:02","commitOrder":4,"curCode":"  public void testNonStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringLastAggregatorFactory factory = new StringLastAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringLastBufferAggregator agg = new StringLastBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes,\n        false\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","date":"2020-01-17 13:02:02","endLine":196,"groupId":"107029","id":6,"instanceNumber":2,"isCurCommit":0,"methodName":"testNonStringValue","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-druid-10-0.7/blobInfo/CC_OUT/blobs/6c/350c4cff1eb8dcceead40874aaafe0e20b9138.src","preCode":"  public void testNonStringValue()\n  {\n\n    final long[] timestamps = {1526724000L, 1526724600L};\n    final Double[] doubles = {null, 2.00};\n    Integer maxStringBytes = 1024;\n\n    TestLongColumnSelector longColumnSelector = new TestLongColumnSelector(timestamps);\n    TestObjectColumnSelector<Double> objectColumnSelector = new TestObjectColumnSelector<>(doubles);\n\n    StringLastAggregatorFactory factory = new StringLastAggregatorFactory(\n        \"billy\", \"billy\", maxStringBytes\n    );\n\n    StringLastBufferAggregator agg = new StringLastBufferAggregator(\n        longColumnSelector,\n        objectColumnSelector,\n        maxStringBytes,\n        false\n    );\n\n    ByteBuffer buf = ByteBuffer.allocate(factory.getMaxIntermediateSize());\n    int position = 0;\n\n    agg.init(buf, position);\n    \r\n    for (int i = 0; i < timestamps.length; i++) {\n      aggregateBuffer(longColumnSelector, objectColumnSelector, agg, buf, position);\n    }\n\n    SerializablePairLongString sp = ((SerializablePairLongString) agg.get(buf, position));\n\n    Assert.assertEquals(1526724600L, (long) sp.lhs);\n    Assert.assertEquals(\"2.0\", sp.rhs);\n  }\n","realPath":"processing/src/test/java/org/apache/druid/query/aggregation/last/StringLastBufferAggregatorTest.java","repoName":"druid","snippetEndLine":0,"snippetStartLine":0,"startLine":162,"status":"N"}],"commitId":"8011211a0ca26ae6fd221e3dfcaf64119609c120","commitMessage":"@@@first/last aggregators and nulls (#9161)\n\n* null handling for numeric first/last aggregators.  refactor to not extend nullable numeric agg since they are complex typed aggs\n\n* initially null or not based on config\n\n* review stuff.  make string first/last consistent with null handling of numeric columns.  more tests\n\n* docs\n\n* handle nil selectors.  revert to primitive first/last types so groupby v1 works...\n","date":"2020-01-21 03:51:54","modifiedFileCount":"34","status":"M","submitter":"Clint Wylie"}]
