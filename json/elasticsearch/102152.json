[{"authorTime":"2018-04-26 03:22:53","codes":[{"authorDate":"2018-04-26 03:22:53","commitOrder":1,"curCode":"    public void testBalanceAllNodesStarted() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder().put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1))\n                .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder().addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING.getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Adding three node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder().add(newNode(\"node1\")).add(newNode(\"node2\")).add(newNode(\"node3\"))).build();\n\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(INITIALIZING));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Another round of rebalancing\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder(clusterState.nodes())).build();\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            \r\n            \r\n            \r\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(INITIALIZING));\n        }\n\n        logger.info(\"Reroute, nothing should change\");\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the more shards\");\n        routingNodes = clusterState.getRoutingNodes();\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","date":"2018-04-26 03:22:53","endLine":159,"groupId":"19768","id":1,"instanceNumber":1,"isCurCommit":0,"methodName":"testBalanceAllNodesStarted","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/d6/e54b6e3b3316edc274cf00c43d071e5ea19adc.src","preCode":"    public void testBalanceAllNodesStarted() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder().put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1))\n                .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder().addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING.getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Adding three node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder().add(newNode(\"node1\")).add(newNode(\"node2\")).add(newNode(\"node3\"))).build();\n\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(INITIALIZING));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Another round of rebalancing\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder(clusterState.nodes())).build();\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            \r\n            \r\n            \r\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(INITIALIZING));\n        }\n\n        logger.info(\"Reroute, nothing should change\");\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the more shards\");\n        routingNodes = clusterState.getRoutingNodes();\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","realPath":"server/src/test/java/org/elasticsearch/cluster/routing/allocation/IndexBalanceTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":45,"status":"B"},{"authorDate":"2018-04-26 03:22:53","commitOrder":1,"curCode":"    public void testBalanceIncrementallyStartNodes() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder().put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1))\n                .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder().addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING.getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        logger.info(\"Adding one node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder().add(newNode(\"node1\"))).build();\n\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node2\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the primary shard\");\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n        clusterState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n\n        logger.info(\"Reroute, nothing should change\");\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the backup shard\");\n        routingNodes = clusterState.getRoutingNodes();\n        clusterState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        routingNodes = clusterState.getRoutingNodes();\n\n        clusterState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        routingNodes = clusterState.getRoutingNodes();\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node3\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Reroute, nothing should change\");\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the backup shard\");\n        routingNodes = clusterState.getRoutingNodes();\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","date":"2018-04-26 03:22:53","endLine":182,"groupId":"42554","id":2,"instanceNumber":2,"isCurCommit":0,"methodName":"testBalanceIncrementallyStartNodes","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/94/01cc1ca6f45c82df1572b37cf9533220ddce5c.src","preCode":"    public void testBalanceIncrementallyStartNodes() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder().put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1))\n                .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder().addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING.getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        logger.info(\"Adding one node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder().add(newNode(\"node1\"))).build();\n\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node2\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the primary shard\");\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n        clusterState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n\n        logger.info(\"Reroute, nothing should change\");\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the backup shard\");\n        routingNodes = clusterState.getRoutingNodes();\n        clusterState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        routingNodes = clusterState.getRoutingNodes();\n\n        clusterState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        routingNodes = clusterState.getRoutingNodes();\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node3\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Reroute, nothing should change\");\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the backup shard\");\n        routingNodes = clusterState.getRoutingNodes();\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","realPath":"server/src/test/java/org/elasticsearch/cluster/routing/allocation/RoutingNodesIntegrityTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":105,"status":"B"}],"commitId":"d74fb9eb4559077e2d20b19a9ed62d9ff825027a","commitMessage":"@@@Opened x-pack ILM code\n","date":"2018-04-26 03:22:53","modifiedFileCount":"0","status":"B","submitter":"Tal Levy"},{"authorTime":"2019-07-18 13:39:24","codes":[{"authorDate":"2019-07-18 13:39:24","commitOrder":2,"curCode":"    public void testBalanceAllNodesStarted() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder().put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT))\n            .numberOfShards(3).numberOfReplicas(1))\n                .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder()\n            .addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING\n            .getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Adding three node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder().add(newNode(\"node1\")).add(newNode(\"node2\"))\n                    .add(newNode(\"node3\"))).build();\n\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(INITIALIZING));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Another round of rebalancing\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder(clusterState.nodes())).build();\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            \r\n            \r\n            \r\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(INITIALIZING));\n        }\n\n        logger.info(\"Reroute, nothing should change\");\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the more shards\");\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","date":"2019-07-18 13:39:24","endLine":161,"groupId":"19768","id":3,"instanceNumber":1,"isCurCommit":0,"methodName":"testBalanceAllNodesStarted","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/68/6dcc0643ae5184bff9b6a20ae61f9456f1f4d6.src","preCode":"    public void testBalanceAllNodesStarted() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder().put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT))\n            .numberOfShards(3).numberOfReplicas(1))\n                .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder()\n            .addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING\n            .getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Adding three node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder().add(newNode(\"node1\")).add(newNode(\"node2\"))\n                    .add(newNode(\"node3\"))).build();\n\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(INITIALIZING));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Another round of rebalancing\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder(clusterState.nodes())).build();\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            \r\n            \r\n            \r\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(INITIALIZING));\n        }\n\n        logger.info(\"Reroute, nothing should change\");\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the more shards\");\n        routingNodes = clusterState.getRoutingNodes();\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","realPath":"server/src/test/java/org/elasticsearch/cluster/routing/allocation/IndexBalanceTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":45,"status":"M"},{"authorDate":"2019-07-18 13:39:24","commitOrder":2,"curCode":"    public void testBalanceIncrementallyStartNodes() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder()\n            .put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1))\n            .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder()\n            .addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING\n            .getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        logger.info(\"Adding one node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder().add(newNode(\"node1\"))).build();\n\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node2\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the primary shard\");\n        clusterState = startInitializingShardsAndReroute(strategy, clusterState);\n\n        logger.info(\"Reroute, nothing should change\");\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the backup shard\");\n        clusterState = startInitializingShardsAndReroute(strategy, clusterState);\n\n        clusterState = startInitializingShardsAndReroute(strategy, clusterState);\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node3\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Reroute, nothing should change\");\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the backup shard\");\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","date":"2019-07-18 13:39:24","endLine":179,"groupId":"42554","id":4,"instanceNumber":2,"isCurCommit":0,"methodName":"testBalanceIncrementallyStartNodes","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/3d/52ae1087218ac420f74bd2691d3404f891f713.src","preCode":"    public void testBalanceIncrementallyStartNodes() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder()\n            .put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1))\n            .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder()\n            .addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING\n            .getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        logger.info(\"Adding one node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder().add(newNode(\"node1\"))).build();\n\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node2\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the primary shard\");\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n        clusterState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n\n        logger.info(\"Reroute, nothing should change\");\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the backup shard\");\n        routingNodes = clusterState.getRoutingNodes();\n        clusterState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        routingNodes = clusterState.getRoutingNodes();\n\n        clusterState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        routingNodes = clusterState.getRoutingNodes();\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node3\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Reroute, nothing should change\");\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the backup shard\");\n        routingNodes = clusterState.getRoutingNodes();\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n\n        newState = strategy.applyStartedShards(clusterState, routingNodes.shardsWithState(INITIALIZING));\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","realPath":"server/src/test/java/org/elasticsearch/cluster/routing/allocation/RoutingNodesIntegrityTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":105,"status":"M"}],"commitId":"51fb95ef83f7a1aa6cbc5207e504b03ccee724ee","commitMessage":"@@@Defer reroute when starting shards (#44433)\n\n* Defer reroute when starting shards\n\nToday we reroute the cluster as part of the process of starting a shard.  which\nruns at `URGENT` priority. In large clusters.  rerouting may take some time to\ncomplete.  and this means that a mere trickle of shard-started events can cause\nstarvation for other.  lower-priority.  tasks that are pending on the master.\n\nHowever.  it isn't really necessary to perform a reroute when starting a shard. \nas long as one occurs eventually. This commit removes the inline reroute from\nthe process of starting a shard and replaces it with a deferred one that runs\nat `NORMAL` priority.  avoiding starvation of higher-priority tasks.\n\nThis may improve some of the situations related to #42738 and #42105.\n\n* Specific test case for followup priority setting\n\nWe cannot set the priority in all InternalTestClusters because the deprecation\nwarning makes some tests unhappy. This commit adds a specific test instead.\n\n* Checkstyle\n\n* Cluster state always changed here\n\n* Assert consistency of routing nodes\n\n* Restrict setting only to reasonable priorities\n","date":"2019-07-18 13:39:24","modifiedFileCount":"60","status":"M","submitter":"David Turner"},{"authorTime":"2020-04-01 03:52:01","codes":[{"authorDate":"2020-04-01 03:52:01","commitOrder":3,"curCode":"    public void testBalanceAllNodesStarted() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        Metadata metadata = Metadata.builder().put(IndexMetadata.builder(\"test\").settings(settings(Version.CURRENT))\n            .numberOfShards(3).numberOfReplicas(1))\n                .put(IndexMetadata.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder()\n            .addAsNew(metadata.index(\"test\")).addAsNew(metadata.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING\n            .getDefault(Settings.EMPTY)).metadata(metadata).routingTable(initialRoutingTable).build();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Adding three node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder().add(newNode(\"node1\")).add(newNode(\"node2\"))\n                    .add(newNode(\"node3\"))).build();\n\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(INITIALIZING));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Another round of rebalancing\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder(clusterState.nodes())).build();\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            \r\n            \r\n            \r\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(INITIALIZING));\n        }\n\n        logger.info(\"Reroute, nothing should change\");\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the more shards\");\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","date":"2020-04-01 03:52:01","endLine":161,"groupId":"102152","id":5,"instanceNumber":1,"isCurCommit":0,"methodName":"testBalanceAllNodesStarted","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/42/7bc26143be53efe72af46faf521497660c2a96.src","preCode":"    public void testBalanceAllNodesStarted() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder().put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT))\n            .numberOfShards(3).numberOfReplicas(1))\n                .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder()\n            .addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING\n            .getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(0).currentNodeId(), nullValue());\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().get(1).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Adding three node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder().add(newNode(\"node1\")).add(newNode(\"node2\"))\n                    .add(newNode(\"node3\"))).build();\n\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(INITIALIZING));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(UNASSIGNED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).currentNodeId(), nullValue());\n        }\n\n        logger.info(\"Another round of rebalancing\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder(clusterState.nodes())).build();\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            \r\n            \r\n            \r\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(INITIALIZING));\n        }\n\n        logger.info(\"Reroute, nothing should change\");\n        newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the more shards\");\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n        for (int i = 0; i < clusterState.routingTable().index(\"test1\").shards().size(); i++) {\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).shards().size(), equalTo(2));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).primaryShard().state(), equalTo(STARTED));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().size(), equalTo(1));\n            assertThat(clusterState.routingTable().index(\"test1\").shard(i).replicaShards().get(0).state(), equalTo(STARTED));\n        }\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","realPath":"server/src/test/java/org/elasticsearch/cluster/routing/allocation/IndexBalanceTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":45,"status":"M"},{"authorDate":"2020-04-01 03:52:01","commitOrder":3,"curCode":"    public void testBalanceIncrementallyStartNodes() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        Metadata metadata = Metadata.builder()\n            .put(IndexMetadata.builder(\"test\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1))\n            .put(IndexMetadata.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder()\n            .addAsNew(metadata.index(\"test\")).addAsNew(metadata.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING\n            .getDefault(Settings.EMPTY)).metadata(metadata).routingTable(initialRoutingTable).build();\n\n        logger.info(\"Adding one node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder().add(newNode(\"node1\"))).build();\n\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node2\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the primary shard\");\n        clusterState = startInitializingShardsAndReroute(strategy, clusterState);\n\n        logger.info(\"Reroute, nothing should change\");\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the backup shard\");\n        clusterState = startInitializingShardsAndReroute(strategy, clusterState);\n\n        clusterState = startInitializingShardsAndReroute(strategy, clusterState);\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node3\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Reroute, nothing should change\");\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the backup shard\");\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","date":"2020-04-01 03:52:01","endLine":179,"groupId":"102152","id":6,"instanceNumber":2,"isCurCommit":0,"methodName":"testBalanceIncrementallyStartNodes","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/4e/527ccc40ff4acbe4213b3bcd9cdb01a0c77d90.src","preCode":"    public void testBalanceIncrementallyStartNodes() {\n        AllocationService strategy = createAllocationService(Settings.builder()\n                .put(\"cluster.routing.allocation.node_concurrent_recoveries\", 10)\n                .put(\"cluster.routing.allocation.node_initial_primaries_recoveries\", 10)\n                .put(ClusterRebalanceAllocationDecider.CLUSTER_ROUTING_ALLOCATION_ALLOW_REBALANCE_SETTING.getKey(), \"always\")\n                .put(\"cluster.routing.allocation.cluster_concurrent_rebalance\", -1).build());\n\n        logger.info(\"Building initial routing table\");\n\n        MetaData metaData = MetaData.builder()\n            .put(IndexMetaData.builder(\"test\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1))\n            .put(IndexMetaData.builder(\"test1\").settings(settings(Version.CURRENT)).numberOfShards(3).numberOfReplicas(1)).build();\n\n        RoutingTable initialRoutingTable = RoutingTable.builder()\n            .addAsNew(metaData.index(\"test\")).addAsNew(metaData.index(\"test1\")).build();\n\n        ClusterState clusterState = ClusterState.builder(org.elasticsearch.cluster.ClusterName.CLUSTER_NAME_SETTING\n            .getDefault(Settings.EMPTY)).metaData(metaData).routingTable(initialRoutingTable).build();\n\n        logger.info(\"Adding one node and performing rerouting\");\n        clusterState = ClusterState.builder(clusterState).nodes(DiscoveryNodes.builder().add(newNode(\"node1\"))).build();\n\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node2\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the primary shard\");\n        clusterState = startInitializingShardsAndReroute(strategy, clusterState);\n\n        logger.info(\"Reroute, nothing should change\");\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Start the backup shard\");\n        clusterState = startInitializingShardsAndReroute(strategy, clusterState);\n\n        clusterState = startInitializingShardsAndReroute(strategy, clusterState);\n\n        logger.info(\"Add another node and perform rerouting, nothing will happen since primary not started\");\n        clusterState = ClusterState.builder(clusterState)\n                .nodes(DiscoveryNodes.builder(clusterState.nodes()).add(newNode(\"node3\"))).build();\n        clusterState = strategy.reroute(clusterState, \"reroute\");\n\n        logger.info(\"Reroute, nothing should change\");\n        ClusterState newState = strategy.reroute(clusterState, \"reroute\");\n        assertThat(newState, equalTo(clusterState));\n\n        logger.info(\"Start the backup shard\");\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n\n        assertThat(clusterState.routingTable().index(\"test\").shards().size(), equalTo(3));\n\n        newState = startInitializingShardsAndReroute(strategy, clusterState);\n        assertThat(newState, not(equalTo(clusterState)));\n        clusterState = newState;\n        RoutingNodes routingNodes = clusterState.getRoutingNodes();\n\n        assertThat(clusterState.routingTable().index(\"test1\").shards().size(), equalTo(3));\n\n        assertThat(routingNodes.node(\"node1\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node2\").numberOfShardsWithState(STARTED), equalTo(4));\n        assertThat(routingNodes.node(\"node3\").numberOfShardsWithState(STARTED), equalTo(4));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test\", STARTED).size(), equalTo(2));\n\n        assertThat(routingNodes.node(\"node1\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node2\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n        assertThat(routingNodes.node(\"node3\").shardsWithState(\"test1\", STARTED).size(), equalTo(2));\n    }\n","realPath":"server/src/test/java/org/elasticsearch/cluster/routing/allocation/RoutingNodesIntegrityTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":105,"status":"M"}],"commitId":"95a7eed9aa35f47b228e402508709b5bd6703cf4","commitMessage":"@@@Rename MetaData to Metadata in all of the places (#54519)\n\nThis is a simple naming change PR.  to fix the fact that \"metadata\" is a\nsingle English word.  and for too long we have not followed general\nnaming conventions for it. We are also not consistent about it.  for\nexample.  METADATA instead of META_DATA if we were trying to be\nconsistent with MetaData (although METADATA is correct when considered\nin the context of \"metadata\"). This was a simple find and replace across\nthe code base.  only taking a few minutes to fix this naming issue\nforever.","date":"2020-04-01 03:52:01","modifiedFileCount":"1712","status":"M","submitter":"Jason Tedor"}]
