[{"authorTime":"2020-01-13 21:10:02","codes":[{"authorDate":"2020-01-13 21:10:02","commitOrder":1,"curCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(42L));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","date":"2020-01-13 21:10:02","endLine":326,"groupId":"3338","id":1,"instanceNumber":1,"isCurCommit":0,"methodName":"testStatePersistedOnLoad","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/04/b58ee04e219217f1a10c91b58de2b56289c3a3.src","preCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(42L));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":296,"status":"B"},{"authorDate":"2020-01-13 21:10:02","commitOrder":1,"curCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetaData indexMetaData = createIndexMetaData(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final MetaData metaData = MetaData.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetaData(createCoordinationMetaData(1L)).\n                        put(indexMetaData, false).\n                        build();\n                    state = createClusterState(version, metaData);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","date":"2020-01-13 21:10:02","endLine":509,"groupId":"7998","id":2,"instanceNumber":2,"isCurCommit":0,"methodName":"testStatePersistenceWithIOIssues","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/04/b58ee04e219217f1a10c91b58de2b56289c3a3.src","preCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetaData indexMetaData = createIndexMetaData(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final MetaData metaData = MetaData.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetaData(createCoordinationMetaData(1L)).\n                        put(indexMetaData, false).\n                        build();\n                    state = createClusterState(version, metaData);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":419,"status":"B"}],"commitId":"a0513217dba5d964bf176c8f409baccfbd25359b","commitMessage":"@@@Move metadata storage to Lucene (#50907)\n\nToday we split the on-disk cluster metadata across many files: one file for the metadata of each\nindex.  plus one file for the global metadata and another for the manifest. Most metadata updates\nonly touch a few of these files.  but some must write them all. If a node holds a large number of\nindices then it's possible its disks are not fast enough to process a complete metadata update before timing out. In severe cases affecting master-eligible nodes this can prevent an election\nfrom succeeding.\n\nThis commit uses Lucene as a metadata storage for the cluster state.  and is a squashed version\nof the following PRs that were targeting a feature branch:\n\n\n* Introduce Lucene-based metadata persistence (#48733)\n\nThis commit introduces `LucenePersistedState` which master-eligible nodes\ncan use to persist the cluster metadata in a Lucene index rather than in\nmany separate files.\n\nRelates #48701\n\n* Remove per-index metadata without assigned shards (#49234)\n\nToday on master-eligible nodes we maintain per-index metadata files for every\nindex. However.  we also keep this metadata in the `LucenePersistedState`.  and\nonly use the per-index metadata files for importing dangling indices. However\nthere is no point in importing a dangling index without any shard data.  so we\ndo not need to maintain these extra files any more.\n\nThis commit removes per-index metadata files from nodes which do not hold any\nshards of those indices.\n\nRelates #48701\n\n* Use Lucene exclusively for metadata storage (#50144)\n\nThis moves metadata persistence to Lucene for all node types. It also reenables BWC and adds\nan interoperability layer for upgrades from prior versions.\n\nThis commit disables a number of tests related to dangling indices and command-line tools.\nThose will be addressed in follow-ups.\n\nRelates #48701\n\n* Add command-line tool support for Lucene-based metadata storage (#50179)\n\nAdds command-line tool support (unsafe-bootstrap.  detach-cluster.  repurpose.  & shard\ncommands) for the Lucene-based metadata storage.\n\nRelates #48701\n\n* Use single directory for metadata (#50639)\n\nEarlier PRs for #48701 introduced a separate directory for the cluster state. This is not needed\nthough.  and introduces an additional unnecessary cognitive burden to the users.\n\nCo-Authored-By: David Turner <david.turner@elastic.co>\n\n* Add async dangling indices support (#50642)\n\nAdds support for writing out dangling indices in an asynchronous way. Also provides an option to\navoid writing out dangling indices at all.\n\nRelates #48701\n\n* Fold node metadata into new node storage (#50741)\n\nMoves node metadata to uses the new storage mechanism (see #48701) as the authoritative source.\n\n* Write CS asynchronously on data-only nodes (#50782)\n\nWrites cluster states out asynchronously on data-only nodes. The main reason for writing out\nthe cluster state at all is so that the data-only nodes can snap into a cluster.  that they can do a\nbit of bootstrap validation and so that the shard recovery tools work.\nCluster states that are written asynchronously have their voting configuration adapted to a non\nexisting configuration so that these nodes cannot mistakenly become master even if their node\nrole is changed back and forth.\n\nRelates #48701\n\n* Remove persistent cluster settings tool (#50694)\n\nAdds the elasticsearch-node remove-settings tool to remove persistent settings from the on\ndisk cluster state in case where it contains incompatible settings that prevent the cluster from\nforming.\n\nRelates #48701\n\n* Make cluster state writer resilient to disk issues (#50805)\n\nAdds handling to make the cluster state writer resilient to disk issues. Relates to #48701\n\n* Omit writing global metadata if no change (#50901)\n\nUses the same optimization for the new cluster state storage layer as the old one.  writing global\nmetadata only when changed. Avoids writing out the global metadata if none of the persistent\nfields changed. Speeds up server:integTest by ~10%.\n\nRelates #48701\n\n* DanglingIndicesIT should ensure node removed first (#50896)\n\nThese tests occasionally failed because the deletion was submitted before the\nrestarting node was removed from the cluster.  causing the deletion not to be\nfully acked. This commit fixes this by checking the restarting node has been\nremoved from the cluster.\n\nCo-authored-by: David Turner <david.turner@elastic.co>\n","date":"2020-01-13 21:10:02","modifiedFileCount":"46","status":"B","submitter":"Yannick Welsch"},{"authorTime":"2020-01-14 21:07:52","codes":[{"authorDate":"2020-01-14 21:07:52","commitOrder":2,"curCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(42L));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","date":"2020-01-14 21:07:52","endLine":328,"groupId":"3338","id":3,"instanceNumber":1,"isCurCommit":0,"methodName":"testStatePersistedOnLoad","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/50/15f74efeeafcc45cf22c52e9f0aaa5f98b444f.src","preCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(42L));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":296,"status":"M"},{"authorDate":"2020-01-14 21:07:52","commitOrder":2,"curCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetaData indexMetaData = createIndexMetaData(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final MetaData metaData = MetaData.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetaData(createCoordinationMetaData(1L)).\n                        put(indexMetaData, false).\n                        build();\n                    state = createClusterState(version, metaData);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","date":"2020-01-14 21:07:52","endLine":514,"groupId":"7998","id":4,"instanceNumber":2,"isCurCommit":0,"methodName":"testStatePersistenceWithIOIssues","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/50/15f74efeeafcc45cf22c52e9f0aaa5f98b444f.src","preCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetaData indexMetaData = createIndexMetaData(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final MetaData metaData = MetaData.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetaData(createCoordinationMetaData(1L)).\n                        put(indexMetaData, false).\n                        build();\n                    state = createClusterState(version, metaData);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":422,"status":"M"}],"commitId":"5736dfb8c31d73a541d5740ba267317720f1fda6","commitMessage":"@@@Warn on slow metadata performance (#50956)\n\nHas the new cluster state storage layer emit warnings in case metadata performance is very\nslow.\n\nRelates #48701","date":"2020-01-14 21:07:52","modifiedFileCount":"19","status":"M","submitter":"Yannick Welsch"},{"authorTime":"2020-04-01 03:52:01","codes":[{"authorDate":"2020-04-01 03:52:01","commitOrder":3,"curCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(42L));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metadata(onDiskState.metadata).build());\n            }\n        }\n    }\n","date":"2020-04-01 03:52:01","endLine":328,"groupId":"3338","id":5,"instanceNumber":1,"isCurCommit":0,"methodName":"testStatePersistedOnLoad","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/f8/5a36e5e887f340783f6f6b4577426a8c72db35.src","preCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(42L));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":296,"status":"M"},{"authorDate":"2020-04-01 03:52:01","commitOrder":3,"curCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetadata indexMetadata = createIndexMetadata(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final Metadata metadata = Metadata.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetadata(createCoordinationMetadata(1L)).\n                        put(indexMetadata, false).\n                        build();\n                    state = createClusterState(version, metadata);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metadata(onDiskState.metadata).build());\n            }\n        }\n    }\n","date":"2020-04-01 03:52:01","endLine":514,"groupId":"7998","id":6,"instanceNumber":2,"isCurCommit":0,"methodName":"testStatePersistenceWithIOIssues","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/f8/5a36e5e887f340783f6f6b4577426a8c72db35.src","preCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        MetaData.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetaData indexMetaData = createIndexMetaData(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final MetaData metaData = MetaData.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetaData(createCoordinationMetaData(1L)).\n                        put(indexMetaData, false).\n                        build();\n                    state = createClusterState(version, metaData);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metaData(onDiskState.metaData).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":422,"status":"M"}],"commitId":"95a7eed9aa35f47b228e402508709b5bd6703cf4","commitMessage":"@@@Rename MetaData to Metadata in all of the places (#54519)\n\nThis is a simple naming change PR.  to fix the fact that \"metadata\" is a\nsingle English word.  and for too long we have not followed general\nnaming conventions for it. We are also not consistent about it.  for\nexample.  METADATA instead of META_DATA if we were trying to be\nconsistent with MetaData (although METADATA is correct when considered\nin the context of \"metadata\"). This was a simple find and replace across\nthe code base.  only taking a few minutes to fix this naming issue\nforever.","date":"2020-04-01 03:52:01","modifiedFileCount":"1712","status":"M","submitter":"Jason Tedor"},{"authorTime":"2020-08-18 01:34:59","codes":[{"authorDate":"2020-08-18 01:34:59","commitOrder":4,"curCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(42L));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metadata(onDiskState.metadata).build());\n            }\n        }\n    }\n","date":"2020-08-18 01:34:59","endLine":335,"groupId":"7905","id":7,"instanceNumber":1,"isCurCommit":0,"methodName":"testStatePersistedOnLoad","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/35/e3fdde9c48a0707b2af548c60431bdaf9517b9.src","preCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(42L));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metadata(onDiskState.metadata).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":303,"status":"M"},{"authorDate":"2020-08-18 01:34:59","commitOrder":4,"curCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetadata indexMetadata = createIndexMetadata(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final Metadata metadata = Metadata.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetadata(createCoordinationMetadata(1L)).\n                        put(indexMetadata, false).\n                        build();\n                    state = createClusterState(version, metadata);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metadata(onDiskState.metadata).build());\n            }\n        }\n    }\n","date":"2020-08-18 01:34:59","endLine":533,"groupId":"7998","id":8,"instanceNumber":2,"isCurCommit":0,"methodName":"testStatePersistenceWithIOIssues","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/35/e3fdde9c48a0707b2af548c60431bdaf9517b9.src","preCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetadata indexMetadata = createIndexMetadata(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final Metadata metadata = Metadata.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetadata(createCoordinationMetadata(1L)).\n                        put(indexMetadata, false).\n                        build();\n                    state = createClusterState(version, metadata);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), BigArrays.NON_RECYCLING_INSTANCE,\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metadata(onDiskState.metadata).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":441,"status":"M"}],"commitId":"99c885e5dad18c791ff91d03542abf85ad983ad7","commitMessage":"@@@Merge branch 'master' into feature/runtime_fields\n","date":"2020-08-18 01:34:59","modifiedFileCount":"346","status":"M","submitter":"Nik Everett"},{"authorTime":"2021-05-12 20:50:26","codes":[{"authorDate":"2021-05-12 20:50:26","commitOrder":5,"curCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        Path path = nodeEnvironment.nodeDataPath();\n        Settings settings = Settings.builder()\n            .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n            .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n        try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n            final PersistedClusterStateService newPersistedClusterStateService =\n                new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                    new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n            final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadOnDiskState();\n            assertFalse(onDiskState.empty());\n            assertThat(onDiskState.currentTerm, equalTo(42L));\n            assertClusterStateEqual(state,\n                ClusterState.builder(ClusterName.DEFAULT)\n                    .version(onDiskState.lastAcceptedVersion)\n                    .metadata(onDiskState.metadata).build());\n        }\n    }\n","date":"2021-05-12 20:50:26","endLine":323,"groupId":"7905","id":9,"instanceNumber":1,"isCurCommit":0,"methodName":"testStatePersistedOnLoad","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/1a/3b3afb126227e943a7a203ae4ac48c61258745.src","preCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(42L));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metadata(onDiskState.metadata).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":292,"status":"M"},{"authorDate":"2021-05-12 20:50:26","commitOrder":5,"curCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetadata indexMetadata = createIndexMetadata(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final Metadata metadata = Metadata.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetadata(createCoordinationMetadata(1L)).\n                        put(indexMetadata, false).\n                        build();\n                    state = createClusterState(version, metadata);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        Path path = nodeEnvironment.nodeDataPath();\n        Settings settings = Settings.builder()\n            .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n            .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n        try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n            final PersistedClusterStateService newPersistedClusterStateService =\n                new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                    new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n            final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadOnDiskState();\n            assertFalse(onDiskState.empty());\n            assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n            assertClusterStateEqual(state,\n                ClusterState.builder(ClusterName.DEFAULT)\n                    .version(onDiskState.lastAcceptedVersion)\n                    .metadata(onDiskState.metadata).build());\n        }\n    }\n","date":"2021-05-12 20:50:26","endLine":520,"groupId":"7998","id":10,"instanceNumber":2,"isCurCommit":0,"methodName":"testStatePersistenceWithIOIssues","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/1a/3b3afb126227e943a7a203ae4ac48c61258745.src","preCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetadata indexMetadata = createIndexMetadata(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final Metadata metadata = Metadata.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetadata(createCoordinationMetadata(1L)).\n                        put(indexMetadata, false).\n                        build();\n                    state = createClusterState(version, metadata);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        for (Path path : nodeEnvironment.nodeDataPaths()) {\n            Settings settings = Settings.builder()\n                .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n                .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n            try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n                final PersistedClusterStateService newPersistedClusterStateService =\n                    new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                        new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n                final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadBestOnDiskState();\n                assertFalse(onDiskState.empty());\n                assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n                assertClusterStateEqual(state,\n                    ClusterState.builder(ClusterName.DEFAULT)\n                        .version(onDiskState.lastAcceptedVersion)\n                        .metadata(onDiskState.metadata).build());\n            }\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":429,"status":"M"}],"commitId":"4528e780c48ada91fd452b9c51dc1a37772c5f07","commitMessage":"@@@Merge branch 'master' into feature/vector-tiles\n\n# Conflicts:\n#\tx-pack/plugin/spatial/build.gradle\n#\tx-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/SpatialPlugin.java\n","date":"2021-05-12 20:50:26","modifiedFileCount":"564","status":"M","submitter":"iverase"},{"authorTime":"2021-06-07 17:00:50","codes":[{"authorDate":"2021-05-12 20:50:26","commitOrder":6,"curCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        Path path = nodeEnvironment.nodeDataPath();\n        Settings settings = Settings.builder()\n            .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n            .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n        try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n            final PersistedClusterStateService newPersistedClusterStateService =\n                new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                    new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n            final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadOnDiskState();\n            assertFalse(onDiskState.empty());\n            assertThat(onDiskState.currentTerm, equalTo(42L));\n            assertClusterStateEqual(state,\n                ClusterState.builder(ClusterName.DEFAULT)\n                    .version(onDiskState.lastAcceptedVersion)\n                    .metadata(onDiskState.metadata).build());\n        }\n    }\n","date":"2021-05-12 20:50:26","endLine":323,"groupId":"103700","id":11,"instanceNumber":1,"isCurCommit":0,"methodName":"testStatePersistedOnLoad","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/1a/3b3afb126227e943a7a203ae4ac48c61258745.src","preCode":"    public void testStatePersistedOnLoad() throws IOException {\n        \r\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n        final ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        try (GatewayMetaState.LucenePersistedState ignored = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, 42L, state)) {\n\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        Path path = nodeEnvironment.nodeDataPath();\n        Settings settings = Settings.builder()\n            .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n            .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n        try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n            final PersistedClusterStateService newPersistedClusterStateService =\n                new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                    new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n            final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadOnDiskState();\n            assertFalse(onDiskState.empty());\n            assertThat(onDiskState.currentTerm, equalTo(42L));\n            assertClusterStateEqual(state,\n                ClusterState.builder(ClusterName.DEFAULT)\n                    .version(onDiskState.lastAcceptedVersion)\n                    .metadata(onDiskState.metadata).build());\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":292,"status":"N"},{"authorDate":"2021-06-07 17:00:50","commitOrder":6,"curCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = between(1, 5); 0 <= i; i--) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetadata indexMetadata = createIndexMetadata(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final Metadata metadata = Metadata.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetadata(createCoordinationMetadata(1L)).\n                        put(indexMetadata, false).\n                        build();\n                    state = createClusterState(version, metadata);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        Path path = nodeEnvironment.nodeDataPath();\n        Settings settings = Settings.builder()\n            .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n            .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n        try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n            final PersistedClusterStateService newPersistedClusterStateService =\n                new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                    new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n            final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadOnDiskState();\n            assertFalse(onDiskState.empty());\n            assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n            assertClusterStateEqual(state,\n                ClusterState.builder(ClusterName.DEFAULT)\n                    .version(onDiskState.lastAcceptedVersion)\n                    .metadata(onDiskState.metadata).build());\n        }\n    }\n","date":"2021-06-07 17:00:50","endLine":524,"groupId":"103700","id":12,"instanceNumber":2,"isCurCommit":0,"methodName":"testStatePersistenceWithIOIssues","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/04/d6256fb1ed4b1eb5800030acb607a01dfd14df.src","preCode":"    public void testStatePersistenceWithIOIssues() throws IOException {\n        final AtomicReference<Double> ioExceptionRate = new AtomicReference<>(0.01d);\n        final List<MockDirectoryWrapper> list = new ArrayList<>();\n        final PersistedClusterStateService persistedClusterStateService =\n            new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L) {\n                @Override\n                Directory createDirectory(Path path) {\n                    final MockDirectoryWrapper wrapper = newMockFSDirectory(path);\n                    wrapper.setAllowRandomFileNotFoundException(randomBoolean());\n                    wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                    wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n                    list.add(wrapper);\n                    return wrapper;\n                }\n            };\n        ClusterState state = createClusterState(randomNonNegativeLong(),\n            Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n        long currentTerm = 42L;\n        try (GatewayMetaState.LucenePersistedState persistedState = new GatewayMetaState.LucenePersistedState(\n            persistedClusterStateService, currentTerm, state)) {\n\n            try {\n                if (randomBoolean()) {\n                    final ClusterState newState = createClusterState(randomNonNegativeLong(),\n                        Metadata.builder().clusterUUID(randomAlphaOfLength(10)).build());\n                    persistedState.setLastAcceptedState(newState);\n                    state = newState;\n                } else {\n                    final long newTerm = currentTerm + 1;\n                    persistedState.setCurrentTerm(newTerm);\n                    currentTerm = newTerm;\n                }\n            } catch (IOError | Exception e) {\n                assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            }\n\n            ioExceptionRate.set(0.0d);\n            for (MockDirectoryWrapper wrapper : list) {\n                wrapper.setRandomIOExceptionRate(ioExceptionRate.get());\n                wrapper.setRandomIOExceptionRateOnOpen(ioExceptionRate.get());\n            }\n\n            for (int i = 0; i < randomIntBetween(1, 5); i++) {\n                if (randomBoolean()) {\n                    final long version = randomNonNegativeLong();\n                    final String indexName = randomAlphaOfLength(10);\n                    final IndexMetadata indexMetadata = createIndexMetadata(indexName, randomIntBetween(1, 5), randomNonNegativeLong());\n                    final Metadata metadata = Metadata.builder().\n                        persistentSettings(Settings.builder().put(randomAlphaOfLength(10), randomAlphaOfLength(10)).build()).\n                        coordinationMetadata(createCoordinationMetadata(1L)).\n                        put(indexMetadata, false).\n                        build();\n                    state = createClusterState(version, metadata);\n                    persistedState.setLastAcceptedState(state);\n                } else {\n                    currentTerm += 1;\n                    persistedState.setCurrentTerm(currentTerm);\n                }\n            }\n\n            assertEquals(state, persistedState.getLastAcceptedState());\n            assertEquals(currentTerm, persistedState.getCurrentTerm());\n\n        } catch (IOError | Exception e) {\n            if (ioExceptionRate.get() == 0.0d) {\n                throw e;\n            }\n            assertNotNull(ExceptionsHelper.unwrap(e, IOException.class));\n            return;\n        }\n\n        nodeEnvironment.close();\n\n        \r\n        Path path = nodeEnvironment.nodeDataPath();\n        Settings settings = Settings.builder()\n            .put(Environment.PATH_HOME_SETTING.getKey(), createTempDir().toAbsolutePath())\n            .put(Environment.PATH_DATA_SETTING.getKey(), path.toString()).build();\n        try (NodeEnvironment nodeEnvironment = new NodeEnvironment(settings, TestEnvironment.newEnvironment(settings))) {\n            final PersistedClusterStateService newPersistedClusterStateService =\n                new PersistedClusterStateService(nodeEnvironment, xContentRegistry(), getBigArrays(),\n                    new ClusterSettings(settings, ClusterSettings.BUILT_IN_CLUSTER_SETTINGS), () -> 0L);\n            final PersistedClusterStateService.OnDiskState onDiskState = newPersistedClusterStateService.loadOnDiskState();\n            assertFalse(onDiskState.empty());\n            assertThat(onDiskState.currentTerm, equalTo(currentTerm));\n            assertClusterStateEqual(state,\n                ClusterState.builder(ClusterName.DEFAULT)\n                    .version(onDiskState.lastAcceptedVersion)\n                    .metadata(onDiskState.metadata).build());\n        }\n    }\n","realPath":"server/src/test/java/org/elasticsearch/gateway/GatewayMetaStatePersistedStateTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":433,"status":"M"}],"commitId":"9cbc5f7e8fd4a73255d4ed35d4935410b52b9bcd","commitMessage":"@@@Merge branch 'master' into feature/vector-tiles\n","date":"2021-06-07 17:00:50","modifiedFileCount":"192","status":"M","submitter":"iverase"}]
