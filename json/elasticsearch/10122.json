[{"authorTime":"2018-12-22 20:21:49","codes":[{"authorDate":"2018-12-22 20:21:49","commitOrder":1,"curCode":"    public void testLazyLoading() throws Exception {\n        \r\n        \r\n        assumeFalse(\"windows deletion behavior is asinine\", Constants.WINDOWS);\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","date":"2018-12-22 20:21:49","endLine":348,"groupId":"53095","id":1,"instanceNumber":1,"isCurCommit":0,"methodName":"testLazyLoading","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/a9/62e8793970a8a39a319688c8bf34689253141c.src","preCode":"    public void testLazyLoading() throws Exception {\n        \r\n        \r\n        assumeFalse(\"windows deletion behavior is asinine\", Constants.WINDOWS);\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":294,"status":"B"},{"authorDate":"2018-12-22 20:21:49","commitOrder":1,"curCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","date":"2018-12-22 20:21:49","endLine":383,"groupId":"53095","id":2,"instanceNumber":2,"isCurCommit":0,"methodName":"testLoadingCustomDatabase","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/a9/62e8793970a8a39a319688c8bf34689253141c.src","preCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":350,"status":"B"}],"commitId":"e1717df0ac814caa26d3ecba54e8bc95a905628a","commitMessage":"@@@Package ingest-geoip as a module (#36898)\n\nThis commit moves ingest-geoip from being a plugin to being a module\nthat is packaged with Elasticsearch distributions.","date":"2018-12-22 20:21:49","modifiedFileCount":"4","status":"B","submitter":"Jason Tedor"},{"authorTime":"2018-12-22 20:21:49","codes":[{"authorDate":"2019-08-21 20:45:51","commitOrder":2,"curCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","date":"2019-08-21 20:45:51","endLine":297,"groupId":"53095","id":3,"instanceNumber":1,"isCurCommit":0,"methodName":"testLazyLoading","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/20/a1362dd53a974bf8c322fcda2b4a05fea7dc6d.src","preCode":"    public void testLazyLoading() throws Exception {\n        \r\n        \r\n        assumeFalse(\"windows deletion behavior is asinine\", Constants.WINDOWS);\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":246,"status":"M"},{"authorDate":"2018-12-22 20:21:49","commitOrder":2,"curCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","date":"2018-12-22 20:21:49","endLine":383,"groupId":"53095","id":4,"instanceNumber":2,"isCurCommit":0,"methodName":"testLoadingCustomDatabase","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/a9/62e8793970a8a39a319688c8bf34689253141c.src","preCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":350,"status":"N"}],"commitId":"44133b77258d02061e121f164fe3056ff156e815","commitMessage":"@@@Fix GeoIpProcessorFactoryTests on windows (#45668)\n\nSwitches windows build to use geoip database loaded on heap instead\nof memory mapping it.\n\nCloses #44552","date":"2019-08-21 20:45:51","modifiedFileCount":"1","status":"M","submitter":"Igor Motov"},{"authorTime":"2019-10-11 17:23:55","codes":[{"authorDate":"2019-10-11 17:23:55","commitOrder":3,"curCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","date":"2019-10-11 17:23:55","endLine":297,"groupId":"30761","id":5,"instanceNumber":1,"isCurCommit":0,"methodName":"testLazyLoading","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/00/1248497f0f9d5c1daa0f0b81d1c1091bd3a140.src","preCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":246,"status":"M"},{"authorDate":"2019-10-11 17:23:55","commitOrder":3,"curCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","date":"2019-10-11 17:23:55","endLine":332,"groupId":"30761","id":6,"instanceNumber":2,"isCurCommit":0,"methodName":"testLoadingCustomDatabase","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/00/1248497f0f9d5c1daa0f0b81d1c1091bd3a140.src","preCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"type\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":299,"status":"M"}],"commitId":"566e1b7d33ec62e2f6011245782cd65d6381ee43","commitMessage":"@@@Remove type field from DocWriteRequest and associated Response objects (#47671)\n\nThis commit removes the type field from index.  update and delete requests.  and their\nassociated responses.\n\nRelates to #41059","date":"2019-10-11 17:23:55","modifiedFileCount":"145","status":"M","submitter":"Alan Woodward"},{"authorTime":"2020-06-16 05:08:29","codes":[{"authorDate":"2020-06-16 05:08:29","commitOrder":4,"curCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","date":"2020-06-16 05:08:29","endLine":297,"groupId":"30761","id":7,"instanceNumber":1,"isCurCommit":0,"methodName":"testLazyLoading","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/86/f14c59403133c0efaeea66f3f403858fc770c9.src","preCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":246,"status":"M"},{"authorDate":"2020-06-16 05:08:29","commitOrder":4,"curCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","date":"2020-06-16 05:08:29","endLine":332,"groupId":"30761","id":8,"instanceNumber":2,"isCurCommit":0,"methodName":"testLoadingCustomDatabase","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/86/f14c59403133c0efaeea66f3f403858fc770c9.src","preCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":299,"status":"M"}],"commitId":"69a6a18d8dc3f95001cfe6f55c1451ac616f7e84","commitMessage":"@@@Add optional description parameter to ingest processors. (#57906)\n\nThis commit adds an optional field.  `description`.  to all ingest processors\nso that users can explain the purpose of the specific processor instance.\n\nCloses #56000.","date":"2020-06-16 05:08:29","modifiedFileCount":"125","status":"M","submitter":"Tal Levy"},{"authorTime":"2021-02-11 17:15:19","codes":[{"authorDate":"2021-02-11 17:15:19","commitOrder":5,"curCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders =\n            IngestGeoIpPlugin.loadDatabaseReaders(new GeoIpCache(1000), geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders);\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","date":"2021-02-11 17:15:19","endLine":286,"groupId":"30761","id":9,"instanceNumber":1,"isCurCommit":0,"methodName":"testLazyLoading","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/a0/062ba17cbd37df443a754b10827746668fd924.src","preCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":234,"status":"M"},{"authorDate":"2021-02-11 17:15:19","commitOrder":5,"curCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders =\n            IngestGeoIpPlugin.loadDatabaseReaders(new GeoIpCache(1000), geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders);\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","date":"2021-02-11 17:15:19","endLine":322,"groupId":"30761","id":10,"instanceNumber":2,"isCurCommit":0,"methodName":"testLoadingCustomDatabase","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/a0/062ba17cbd37df443a754b10827746668fd924.src","preCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders = IngestGeoIpPlugin.loadDatabaseReaders(geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders, new GeoIpCache(1000));\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":288,"status":"M"}],"commitId":"5529b3d583773eb2725ce8253856092787af383c","commitMessage":"@@@Changed how geoip cache is integrated with geoip processor. (#68581)\n\nThis change helps facilitate allowing maxmind databases to be updated at runtime.\nThis will make is easier to purge the cache if a database changes.\n\nMade the following changes:\n* Changed how geoip processor integrates with the cache. The cache is moved from the geoip processor to DatabaseReaderLazyLoader class.\n* Changed the cache key from ip + response class to ip + database_path.\n* Moved GeoIpCache from IngestGeoIpPlugin class to be a top level class.","date":"2021-02-11 17:15:19","modifiedFileCount":"5","status":"M","submitter":"Martijn van Groningen"},{"authorTime":"2021-02-23 22:16:52","codes":[{"authorDate":"2021-02-23 22:16:52","commitOrder":6,"curCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, new GeoIpCache(1000));\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(localDatabases);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(localDatabases.getDatabase(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(localDatabases.getDatabase(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(localDatabases.getDatabase(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(localDatabases.getDatabase(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(localDatabases.getDatabase(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(localDatabases.getDatabase(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","date":"2021-02-23 22:16:52","endLine":284,"groupId":"30414","id":11,"instanceNumber":1,"isCurCommit":0,"methodName":"testLazyLoading","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/b2/e0390ca545812f1fa67f12310e91ce299367be.src","preCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Map<String, DatabaseReaderLazyLoader> databaseReaders =\n            IngestGeoIpPlugin.loadDatabaseReaders(new GeoIpCache(1000), geoIpDir, geoIpConfigDir);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders);\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":233,"status":"M"},{"authorDate":"2021-02-23 22:16:52","commitOrder":6,"curCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        ThreadPool threadPool = new TestThreadPool(\"test\");\n        ResourceWatcherService resourceWatcherService = new ResourceWatcherService(Settings.EMPTY, threadPool);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, new GeoIpCache(1000));\n        localDatabases.initialize(resourceWatcherService);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(localDatabases);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(localDatabases.getDatabase(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(localDatabases.getDatabase(\"GeoIP2-City.mmdb\").databaseReader.get());\n        resourceWatcherService.close();\n        threadPool.shutdown();\n    }\n","date":"2021-02-23 22:16:52","endLine":324,"groupId":"30414","id":12,"instanceNumber":2,"isCurCommit":0,"methodName":"testLoadingCustomDatabase","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/b2/e0390ca545812f1fa67f12310e91ce299367be.src","preCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        final Map<String, DatabaseReaderLazyLoader> databaseReaders =\n            IngestGeoIpPlugin.loadDatabaseReaders(new GeoIpCache(1000), geoIpDir, geoIpConfigDir);\n        final GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseReaders);\n        for (DatabaseReaderLazyLoader lazyLoader : databaseReaders.values()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseReaders.get(\"GeoIP2-City.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":286,"status":"M"}],"commitId":"683a14c504119361f5dc0bd1c557bd81f49377a6","commitMessage":"@@@Allow custom geoip databases to be updated at runtime. (#68901)\n\nCustom geoip databases can be provided via the config/ingest-geoip directory. \nwhich are loaded at node startup time. This change adds the functionality\nthat reloads custom databases at runtime.\n\nAdded reference counting when getting a DatabaseReaderLazyLoader instance. \nthis to avoid closing a maxmind db reader while it is still being used.\nThere is a small window of time where this might happen during a database update.\n\nA DatabaseReaderLazyLoader instance (which wraps a Maxmind db reader) from config database directory:\n* Is closed immediately if there are no usages of it by any geoip processor instance as part of the database reload.\n* When there are usages.  then it is not closed immediately after a database reload. It is closed by the caller that did the last geoip lookup using this DatabaseReaderLazyLoader instance.","date":"2021-02-23 22:16:52","modifiedFileCount":"7","status":"M","submitter":"Martijn van Groningen"},{"authorTime":"2021-03-04 22:01:13","codes":[{"authorDate":"2021-03-04 22:01:13","commitOrder":7,"curCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, cache);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n    }\n","date":"2021-03-04 22:01:13","endLine":299,"groupId":"54709","id":13,"instanceNumber":1,"isCurCommit":0,"methodName":"testLazyLoading","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/43/96574a0a9ccfa86a7eebe14359e2b4032699b1.src","preCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, new GeoIpCache(1000));\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(localDatabases);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(localDatabases.getDatabase(\"GeoLite2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(localDatabases.getDatabase(\"GeoLite2-City.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(localDatabases.getDatabase(\"GeoLite2-Country.mmdb\").databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(localDatabases.getDatabase(\"GeoLite2-Country.mmdb\").databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(localDatabases.getDatabase(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(localDatabases.getDatabase(\"GeoLite2-ASN.mmdb\").databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":245,"status":"M"},{"authorDate":"2021-03-04 22:01:13","commitOrder":7,"curCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        ThreadPool threadPool = new TestThreadPool(\"test\");\n        ResourceWatcherService resourceWatcherService = new ResourceWatcherService(Settings.EMPTY, threadPool);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, new GeoIpCache(1000));\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        databaseRegistry.initialize(resourceWatcherService, mock(IngestService.class));\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        resourceWatcherService.close();\n        threadPool.shutdown();\n    }\n","date":"2021-03-04 22:01:13","endLine":342,"groupId":"56351","id":14,"instanceNumber":2,"isCurCommit":0,"methodName":"testLoadingCustomDatabase","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/43/96574a0a9ccfa86a7eebe14359e2b4032699b1.src","preCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        ThreadPool threadPool = new TestThreadPool(\"test\");\n        ResourceWatcherService resourceWatcherService = new ResourceWatcherService(Settings.EMPTY, threadPool);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, new GeoIpCache(1000));\n        localDatabases.initialize(resourceWatcherService);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(localDatabases);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(localDatabases.getDatabase(\"GeoIP2-City.mmdb\").databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(localDatabases.getDatabase(\"GeoIP2-City.mmdb\").databaseReader.get());\n        resourceWatcherService.close();\n        threadPool.shutdown();\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":301,"status":"M"}],"commitId":"6c35c2508192366d462b8fd5d11038facafc7674","commitMessage":"@@@Add DatabaseRegistry for locally managing databases managed by GeoIpDownloader (#69540)\n\nThis component is responsible for making the databases maintained by GeoIpDownloader\navailable for ingest processors.\n\nAlso provided a lookup mechanism for geoip processors with fallback to {@link LocalDatabases}.\nAll databases are downloaded into a geoip tmp directory.  which is created at node startup.\n\nThe following high level steps are executed after each cluster state update:\n1) Check which databases are available in {@link GeoIpTaskState}. \n   which is part of the geoip downloader persistent task.\n2) For each database check whether the databases have changed\n   by comparing the local and remote md5 hash or are locally missing.\n3) For each database identified in step 2 start downloading the database\n   chunks. Each chunks is appended to a tmp file (inside geoip tmp dir) and\n   after all chunks have been downloaded.  the database is uncompressed and\n   renamed to the final filename. After this the database is loaded and\n   if there is an old instance of this database then that is closed.\n4) Cleanup locally loaded databases that are no longer mentioned in {@link GeoIpTaskState}.\n\nRelates to #68920","date":"2021-03-04 22:01:13","modifiedFileCount":"10","status":"M","submitter":"Martijn van Groningen"},{"authorTime":"2021-03-17 20:20:56","codes":[{"authorDate":"2021-03-04 22:01:13","commitOrder":8,"curCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, cache);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n    }\n","date":"2021-03-04 22:01:13","endLine":299,"groupId":"54709","id":15,"instanceNumber":1,"isCurCommit":0,"methodName":"testLazyLoading","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/43/96574a0a9ccfa86a7eebe14359e2b4032699b1.src","preCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, cache);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":245,"status":"N"},{"authorDate":"2021-03-17 20:20:56","commitOrder":8,"curCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        ThreadPool threadPool = new TestThreadPool(\"test\");\n        ResourceWatcherService resourceWatcherService = new ResourceWatcherService(Settings.EMPTY, threadPool);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, new GeoIpCache(1000));\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        databaseRegistry.initialize(\"nodeId\", resourceWatcherService, mock(IngestService.class));\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        resourceWatcherService.close();\n        threadPool.shutdown();\n    }\n","date":"2021-03-17 20:20:56","endLine":342,"groupId":"56351","id":16,"instanceNumber":2,"isCurCommit":0,"methodName":"testLoadingCustomDatabase","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/61/d6bfd5e3eb89b30d82403871c4ed5ccd8abb09.src","preCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        ThreadPool threadPool = new TestThreadPool(\"test\");\n        ResourceWatcherService resourceWatcherService = new ResourceWatcherService(Settings.EMPTY, threadPool);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, new GeoIpCache(1000));\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        databaseRegistry.initialize(resourceWatcherService, mock(IngestService.class));\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        resourceWatcherService.close();\n        threadPool.shutdown();\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":301,"status":"M"}],"commitId":"3d3ec5c4fe50d58a033830ee4910fec164103582","commitMessage":"@@@Take the node id into account when creating geoip tmp dir. (#70462)\n\nThis change adjust where the geoip tmp directory is created\nto avoid issues when running multiple nodes on the same machine.\n\nIn the java tmp dir.  a 'geoip-databases' directory is created and\ndirectly under this directory a directory with the node id as name is created.\nThis allows safely running multiple nodes on the same machine (this\nhappens mainly during tests).\n\nCloses #69972\nRelates to #68920","date":"2021-03-17 20:20:56","modifiedFileCount":"6","status":"M","submitter":"Martijn van Groningen"},{"authorTime":"2021-06-18 19:51:12","codes":[{"authorDate":"2021-06-18 19:51:12","commitOrder":9,"curCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, cache);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry, clusterService);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n    }\n","date":"2021-06-18 19:51:12","endLine":305,"groupId":"10122","id":17,"instanceNumber":1,"isCurCommit":0,"methodName":"testLazyLoading","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/e4/3e37a23e305732e833cbda0548b72ad0f86baa.src","preCode":"    public void testLazyLoading() throws Exception {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n\n        \r\n        \r\n        \r\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, cache);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-City.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-Country.mmdb\");\n        final GeoIpProcessor country = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n        country.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-Country.mmdb\", true).databaseReader.get());\n\n        config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoLite2-ASN.mmdb\");\n        final GeoIpProcessor asn = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n        asn.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoLite2-ASN.mmdb\", true).databaseReader.get());\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":251,"status":"M"},{"authorDate":"2021-06-18 19:51:12","commitOrder":9,"curCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        ThreadPool threadPool = new TestThreadPool(\"test\");\n        ResourceWatcherService resourceWatcherService = new ResourceWatcherService(Settings.EMPTY, threadPool);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, new GeoIpCache(1000));\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        databaseRegistry.initialize(\"nodeId\", resourceWatcherService, mock(IngestService.class));\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry, clusterService);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        resourceWatcherService.close();\n        threadPool.shutdown();\n    }\n","date":"2021-06-18 19:51:12","endLine":348,"groupId":"10122","id":18,"instanceNumber":2,"isCurCommit":0,"methodName":"testLoadingCustomDatabase","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-elasticsearch-10-0.7/blobInfo/CC_OUT/blobs/e4/3e37a23e305732e833cbda0548b72ad0f86baa.src","preCode":"    public void testLoadingCustomDatabase() throws IOException {\n        final Path geoIpDir = createTempDir();\n        final Path configDir = createTempDir();\n        final Path geoIpConfigDir = configDir.resolve(\"ingest-geoip\");\n        Files.createDirectories(geoIpConfigDir);\n        copyDatabaseFiles(geoIpDir);\n        \r\n        copyDatabaseFile(geoIpConfigDir, \"GeoLite2-City.mmdb\");\n        Files.move(geoIpConfigDir.resolve(\"GeoLite2-City.mmdb\"), geoIpConfigDir.resolve(\"GeoIP2-City.mmdb\"));\n\n        \r\n\r\n\r\n\n        ThreadPool threadPool = new TestThreadPool(\"test\");\n        ResourceWatcherService resourceWatcherService = new ResourceWatcherService(Settings.EMPTY, threadPool);\n        LocalDatabases localDatabases = new LocalDatabases(geoIpDir, geoIpConfigDir, new GeoIpCache(1000));\n        Client client = mock(Client.class);\n        GeoIpCache cache = new GeoIpCache(1000);\n        DatabaseRegistry databaseRegistry = new DatabaseRegistry(createTempDir(), client, cache, localDatabases, Runnable::run);\n        databaseRegistry.initialize(\"nodeId\", resourceWatcherService, mock(IngestService.class));\n        GeoIpProcessor.Factory factory = new GeoIpProcessor.Factory(databaseRegistry);\n        for (DatabaseReaderLazyLoader lazyLoader : localDatabases.getAllDatabases()) {\n            assertNull(lazyLoader.databaseReader.get());\n        }\n\n        final Map<String, Object> field = Collections.singletonMap(\"_field\", \"1.1.1.1\");\n        final IngestDocument document = new IngestDocument(\"index\", \"id\", \"routing\", 1L, VersionType.EXTERNAL, field);\n\n        Map<String, Object> config = new HashMap<>();\n        config.put(\"field\", \"_field\");\n        config.put(\"database_file\", \"GeoIP2-City.mmdb\");\n        final GeoIpProcessor city = factory.create(null, \"_tag\", null, config);\n\n        \r\n        assertNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        city.execute(document);\n        \r\n        assertNotNull(databaseRegistry.getDatabase(\"GeoIP2-City.mmdb\", true).databaseReader.get());\n        resourceWatcherService.close();\n        threadPool.shutdown();\n    }\n","realPath":"modules/ingest-geoip/src/test/java/org/elasticsearch/ingest/geoip/GeoIpProcessorFactoryTests.java","repoName":"elasticsearch","snippetEndLine":0,"snippetStartLine":0,"startLine":307,"status":"M"}],"commitId":"331a44ba425d9ae937a8f49a7f94d8d0a02f3b93","commitMessage":"@@@Change GeoIP downloader policy after 30 days of no updates (#74099)\n\nThis PR changes the way GeoIpDownloader and GeoIpProcessor handle situation when we are unable to update databases for 30 days. In that case:\n\nGeoIpDownloader will delete all chunks from .geoip_databases index\nDatabaseRegistry will delete all files on ingest nodes\nGeoIpProcessor will tag document with tags: [\"_geoip_expired_database\"] field (same way as in Logstash)\nThis change also fixes bug with that breaks DatabaseRegistry and when it tires to download databases after updating timestamp only (GeoIpDownloader checks if there are new databases and updates timestamp because local databases are up to date)","date":"2021-06-18 19:51:12","modifiedFileCount":"15","status":"M","submitter":"Przemko Robakowski"}]
