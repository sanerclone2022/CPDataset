[{"authorTime":"2020-11-05 15:00:31","codes":[{"authorDate":"2020-11-05 15:00:31","commitOrder":1,"curCode":"\tpublic void testRemoveAllHandlesAndDiscardState() throws Exception {\n\t\tnew Context() {{\n\t\t\trunTest(\n\t\t\t\t() -> {\n\t\t\t\t\tleaderCallbackGrantLeadership();\n\t\t\t\t\tLongRetrievableStateHandle.clearNumberOfGlobalDiscardCalls();\n\n\t\t\t\t\tfinal KubernetesStateHandleStore<Long> store = new KubernetesStateHandleStore<>(\n\t\t\t\t\t\tflinkKubeClient, LEADER_CONFIGMAP_NAME, longStateStorage, filter, LOCK_IDENTITY);\n\t\t\t\t\tstore.addAndLock(key, state);\n\t\t\t\t\tstore.addAndLock(key + \"1\", 2L);\n\t\t\t\t\tassertThat(store.getAllAndLock().size(), is(2));\n\t\t\t\t\tstore.releaseAndTryRemoveAll();\n\t\t\t\t\tassertThat(store.getAllAndLock().size(), is(0));\n\t\t\t\t\tassertThat(LongRetrievableStateHandle.getNumberOfGlobalDiscardCalls(), is(2));\n\t\t\t\t});\n\t\t}};\n\t}\n","date":"2020-11-08 00:54:31","endLine":390,"groupId":"18579","id":1,"instanceNumber":1,"isCurCommit":0,"methodName":"testRemoveAllHandlesAndDiscardState","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-flink-10-0.7/blobInfo/CC_OUT/blobs/ed/9c1ae9a7df6f18f65843464b5390fe36f7bdad.src","preCode":"\tpublic void testRemoveAllHandlesAndDiscardState() throws Exception {\n\t\tnew Context() {{\n\t\t\trunTest(\n\t\t\t\t() -> {\n\t\t\t\t\tleaderCallbackGrantLeadership();\n\t\t\t\t\tLongRetrievableStateHandle.clearNumberOfGlobalDiscardCalls();\n\n\t\t\t\t\tfinal KubernetesStateHandleStore<Long> store = new KubernetesStateHandleStore<>(\n\t\t\t\t\t\tflinkKubeClient, LEADER_CONFIGMAP_NAME, longStateStorage, filter, LOCK_IDENTITY);\n\t\t\t\t\tstore.addAndLock(key, state);\n\t\t\t\t\tstore.addAndLock(key + \"1\", 2L);\n\t\t\t\t\tassertThat(store.getAllAndLock().size(), is(2));\n\t\t\t\t\tstore.releaseAndTryRemoveAll();\n\t\t\t\t\tassertThat(store.getAllAndLock().size(), is(0));\n\t\t\t\t\tassertThat(LongRetrievableStateHandle.getNumberOfGlobalDiscardCalls(), is(2));\n\t\t\t\t});\n\t\t}};\n\t}\n","realPath":"flink-kubernetes/src/test/java/org/apache/flink/kubernetes/highavailability/KubernetesStateHandleStoreTest.java","repoName":"flink","snippetEndLine":0,"snippetStartLine":0,"startLine":373,"status":"B"},{"authorDate":"2020-11-05 15:00:31","commitOrder":1,"curCode":"\tpublic void testRemoveAllHandles() throws Exception {\n\t\tnew Context() {{\n\t\t\trunTest(\n\t\t\t\t() -> {\n\t\t\t\t\tleaderCallbackGrantLeadership();\n\t\t\t\t\tLongRetrievableStateHandle.clearNumberOfGlobalDiscardCalls();\n\n\t\t\t\t\tfinal String anotherKey = \"key-not-with-prefix\";\n\t\t\t\t\tgetLeaderConfigMap().getData().put(anotherKey, \"value\");\n\n\t\t\t\t\tfinal KubernetesStateHandleStore<Long> store = new KubernetesStateHandleStore<>(\n\t\t\t\t\t\tflinkKubeClient, LEADER_CONFIGMAP_NAME, longStateStorage, filter, LOCK_IDENTITY);\n\t\t\t\t\tstore.addAndLock(key, state);\n\t\t\t\t\tstore.addAndLock(key + \"1\", 2L);\n\t\t\t\t\tassertThat(store.getAllAndLock().size(), is(2));\n\t\t\t\t\tstore.clearEntries();\n\t\t\t\t\tassertThat(store.getAllAndLock().size(), is(0));\n\t\t\t\t\tassertThat(LongRetrievableStateHandle.getNumberOfGlobalDiscardCalls(), is(0));\n\n\t\t\t\t\t\r\n\t\t\t\t\tassertThat(getLeaderConfigMap().getData().containsKey(anotherKey), is(true));\n\t\t\t\t});\n\t\t}};\n\t}\n","date":"2020-11-08 00:54:31","endLine":416,"groupId":"18579","id":2,"instanceNumber":2,"isCurCommit":0,"methodName":"testRemoveAllHandles","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-flink-10-0.7/blobInfo/CC_OUT/blobs/ed/9c1ae9a7df6f18f65843464b5390fe36f7bdad.src","preCode":"\tpublic void testRemoveAllHandles() throws Exception {\n\t\tnew Context() {{\n\t\t\trunTest(\n\t\t\t\t() -> {\n\t\t\t\t\tleaderCallbackGrantLeadership();\n\t\t\t\t\tLongRetrievableStateHandle.clearNumberOfGlobalDiscardCalls();\n\n\t\t\t\t\tfinal String anotherKey = \"key-not-with-prefix\";\n\t\t\t\t\tgetLeaderConfigMap().getData().put(anotherKey, \"value\");\n\n\t\t\t\t\tfinal KubernetesStateHandleStore<Long> store = new KubernetesStateHandleStore<>(\n\t\t\t\t\t\tflinkKubeClient, LEADER_CONFIGMAP_NAME, longStateStorage, filter, LOCK_IDENTITY);\n\t\t\t\t\tstore.addAndLock(key, state);\n\t\t\t\t\tstore.addAndLock(key + \"1\", 2L);\n\t\t\t\t\tassertThat(store.getAllAndLock().size(), is(2));\n\t\t\t\t\tstore.clearEntries();\n\t\t\t\t\tassertThat(store.getAllAndLock().size(), is(0));\n\t\t\t\t\tassertThat(LongRetrievableStateHandle.getNumberOfGlobalDiscardCalls(), is(0));\n\n\t\t\t\t\t\r\n\t\t\t\t\tassertThat(getLeaderConfigMap().getData().containsKey(anotherKey), is(true));\n\t\t\t\t});\n\t\t}};\n\t}\n","realPath":"flink-kubernetes/src/test/java/org/apache/flink/kubernetes/highavailability/KubernetesStateHandleStoreTest.java","repoName":"flink","snippetEndLine":0,"snippetStartLine":0,"startLine":393,"status":"B"}],"commitId":"8b4f28b334af4cb2e36d6f46805f9631ce34e091","commitMessage":"@@@[FLINK-19543][k8s] Implement KubernetesStateHandleStore based on Kubernetes API\n","date":"2020-11-08 00:54:31","modifiedFileCount":"2","status":"B","submitter":"wangyang0918"},{"authorTime":"2021-05-04 19:08:07","codes":[{"authorDate":"2021-05-04 19:08:07","commitOrder":2,"curCode":"    public void testRemoveAllHandlesAndDiscardState() throws Exception {\n        new Context() {\n            {\n                runTest(\n                        () -> {\n                            leaderCallbackGrantLeadership();\n\n                            final KubernetesStateHandleStore<\n                                            TestingLongStateHandleHelper.LongStateHandle>\n                                    store =\n                                            new KubernetesStateHandleStore<>(\n                                                    flinkKubeClient,\n                                                    LEADER_CONFIGMAP_NAME,\n                                                    longStateStorage,\n                                                    filter,\n                                                    LOCK_IDENTITY);\n                            store.addAndLock(key, state);\n                            store.addAndLock(\n                                    key + \"1\",\n                                    new TestingLongStateHandleHelper.LongStateHandle(2L));\n                            assertThat(store.getAllAndLock().size(), is(2));\n                            store.releaseAndTryRemoveAll();\n                            assertThat(store.getAllAndLock().size(), is(0));\n                            assertThat(TestingLongStateHandleHelper.getGlobalDiscardCount(), is(2));\n                        });\n            }\n        };\n    }\n","date":"2021-05-18 16:58:42","endLine":580,"groupId":"102345","id":3,"instanceNumber":1,"isCurCommit":0,"methodName":"testRemoveAllHandlesAndDiscardState","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-flink-10-0.7/blobInfo/CC_OUT/blobs/6e/230f5250fabfd320d3c09968b016e6446942f6.src","preCode":"    public void testRemoveAllHandlesAndDiscardState() throws Exception {\n        new Context() {\n            {\n                runTest(\n                        () -> {\n                            leaderCallbackGrantLeadership();\n                            LongRetrievableStateHandle.clearNumberOfGlobalDiscardCalls();\n\n                            final KubernetesStateHandleStore<Long> store =\n                                    new KubernetesStateHandleStore<>(\n                                            flinkKubeClient,\n                                            LEADER_CONFIGMAP_NAME,\n                                            longStateStorage,\n                                            filter,\n                                            LOCK_IDENTITY);\n                            store.addAndLock(key, state);\n                            store.addAndLock(key + \"1\", 2L);\n                            assertThat(store.getAllAndLock().size(), is(2));\n                            store.releaseAndTryRemoveAll();\n                            assertThat(store.getAllAndLock().size(), is(0));\n                            assertThat(\n                                    LongRetrievableStateHandle.getNumberOfGlobalDiscardCalls(),\n                                    is(2));\n                        });\n            }\n        };\n    }\n","realPath":"flink-kubernetes/src/test/java/org/apache/flink/kubernetes/highavailability/KubernetesStateHandleStoreTest.java","repoName":"flink","snippetEndLine":0,"snippetStartLine":0,"startLine":553,"status":"M"},{"authorDate":"2021-05-04 19:08:07","commitOrder":2,"curCode":"    public void testRemoveAllHandles() throws Exception {\n        new Context() {\n            {\n                runTest(\n                        () -> {\n                            leaderCallbackGrantLeadership();\n\n                            final String anotherKey = \"key-not-with-prefix\";\n                            getLeaderConfigMap().getData().put(anotherKey, \"value\");\n\n                            final KubernetesStateHandleStore<\n                                            TestingLongStateHandleHelper.LongStateHandle>\n                                    store =\n                                            new KubernetesStateHandleStore<>(\n                                                    flinkKubeClient,\n                                                    LEADER_CONFIGMAP_NAME,\n                                                    longStateStorage,\n                                                    filter,\n                                                    LOCK_IDENTITY);\n                            store.addAndLock(key, state);\n                            store.addAndLock(\n                                    key + \"1\",\n                                    new TestingLongStateHandleHelper.LongStateHandle(2L));\n                            assertThat(store.getAllAndLock().size(), is(2));\n                            store.clearEntries();\n                            assertThat(store.getAllAndLock().size(), is(0));\n                            assertThat(TestingLongStateHandleHelper.getGlobalDiscardCount(), is(0));\n\n                            \r\n                            assertThat(\n                                    getLeaderConfigMap().getData().containsKey(anotherKey),\n                                    is(true));\n                        });\n            }\n        };\n    }\n","date":"2021-05-18 16:58:42","endLine":618,"groupId":"102345","id":4,"instanceNumber":2,"isCurCommit":0,"methodName":"testRemoveAllHandles","params":"()","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-flink-10-0.7/blobInfo/CC_OUT/blobs/6e/230f5250fabfd320d3c09968b016e6446942f6.src","preCode":"    public void testRemoveAllHandles() throws Exception {\n        new Context() {\n            {\n                runTest(\n                        () -> {\n                            leaderCallbackGrantLeadership();\n                            LongRetrievableStateHandle.clearNumberOfGlobalDiscardCalls();\n\n                            final String anotherKey = \"key-not-with-prefix\";\n                            getLeaderConfigMap().getData().put(anotherKey, \"value\");\n\n                            final KubernetesStateHandleStore<Long> store =\n                                    new KubernetesStateHandleStore<>(\n                                            flinkKubeClient,\n                                            LEADER_CONFIGMAP_NAME,\n                                            longStateStorage,\n                                            filter,\n                                            LOCK_IDENTITY);\n                            store.addAndLock(key, state);\n                            store.addAndLock(key + \"1\", 2L);\n                            assertThat(store.getAllAndLock().size(), is(2));\n                            store.clearEntries();\n                            assertThat(store.getAllAndLock().size(), is(0));\n                            assertThat(\n                                    LongRetrievableStateHandle.getNumberOfGlobalDiscardCalls(),\n                                    is(0));\n\n                            \r\n                            assertThat(\n                                    getLeaderConfigMap().getData().containsKey(anotherKey),\n                                    is(true));\n                        });\n            }\n        };\n    }\n","realPath":"flink-kubernetes/src/test/java/org/apache/flink/kubernetes/highavailability/KubernetesStateHandleStoreTest.java","repoName":"flink","snippetEndLine":0,"snippetStartLine":0,"startLine":583,"status":"M"}],"commitId":"cc59ad5e62a6183fccbe1d429c608a727f00b307","commitMessage":"@@@[FLINK-22494][ha] Refactors TestingLongStateHandleHelper to operate on references\n\nThe previous implementation stored the state in the StateHandle. This causes\nproblems when deserializing the state creating a new instance that does not\npoint to the actual state but is a copy of this state.\n\nThis refactoring introduces LongStateHandle handling the actual state and\nLongRetrievableStateHandle referencing this handle.\n","date":"2021-05-18 16:58:42","modifiedFileCount":"4","status":"M","submitter":"Matthias Pohl"}]
