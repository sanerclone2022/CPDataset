[{"authorTime":"2018-01-20 05:49:27","codes":[{"authorDate":"2018-01-20 05:49:27","commitOrder":1,"curCode":"    protected Void createTemplateAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback,\n        CreateContext<CreateCmdResult> context) {\n        if (s_logger.isDebugEnabled()) {\n            s_logger.debug(\"Performing image store createTemplate async callback\");\n        }\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        TemplateDataStoreVO tmpltStoreVO = _templateStoreDao.findByStoreTemplate(store.getId(), obj.getId());\n        if (tmpltStoreVO != null) {\n            if (tmpltStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Template is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            TemplateDataStoreVO updateBuilder = _templateStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _templateStoreDao.update(tmpltStoreVO.getId(), updateBuilder);\n            \r\n            VMTemplateVO tmlptUpdater = _templateDao.createForUpdate();\n            tmlptUpdater.setSize(answer.getTemplateSize());\n            _templateDao.update(obj.getId(), tmlptUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to register template: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED, _vmTemplateZoneDao.listByTemplateId(obj.getId()).get(0).getZoneId(), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            if (answer.getCheckSum() != null) {\n                VMTemplateVO templateDaoBuilder = _templateDao.createForUpdate();\n                templateDaoBuilder.setChecksum(answer.getCheckSum());\n                _templateDao.update(obj.getId(), templateDaoBuilder);\n            }\n\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","date":"2018-01-20 05:49:27","endLine":221,"groupId":"24598","id":1,"instanceNumber":1,"isCurCommit":0,"methodName":"createTemplateAsyncCallback","params":"(AsyncCallbackDispatcher<?extendsBaseImageStoreDriverImpl@DownloadAnswer>callback@CreateContext<CreateCmdResult>context)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/1c/6f1e70660fef1a381619b146c4fb04e9c8c32c.src","preCode":"    protected Void createTemplateAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback,\n        CreateContext<CreateCmdResult> context) {\n        if (s_logger.isDebugEnabled()) {\n            s_logger.debug(\"Performing image store createTemplate async callback\");\n        }\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        TemplateDataStoreVO tmpltStoreVO = _templateStoreDao.findByStoreTemplate(store.getId(), obj.getId());\n        if (tmpltStoreVO != null) {\n            if (tmpltStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Template is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            TemplateDataStoreVO updateBuilder = _templateStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _templateStoreDao.update(tmpltStoreVO.getId(), updateBuilder);\n            \r\n            VMTemplateVO tmlptUpdater = _templateDao.createForUpdate();\n            tmlptUpdater.setSize(answer.getTemplateSize());\n            _templateDao.update(obj.getId(), tmlptUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to register template: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED, _vmTemplateZoneDao.listByTemplateId(obj.getId()).get(0).getZoneId(), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            if (answer.getCheckSum() != null) {\n                VMTemplateVO templateDaoBuilder = _templateDao.createForUpdate();\n                templateDaoBuilder.setChecksum(answer.getCheckSum());\n                _templateDao.update(obj.getId(), templateDaoBuilder);\n            }\n\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","realPath":"engine/storage/src/main/java/org/apache/cloudstack/storage/image/BaseImageStoreDriverImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":165,"status":"B"},{"authorDate":"2018-01-20 05:49:27","commitOrder":1,"curCode":"        createVolumeAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback, CreateContext<CreateCmdResult> context) {\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        VolumeDataStoreVO volStoreVO = _volumeStoreDao.findByStoreVolume(store.getId(), obj.getId());\n        if (volStoreVO != null) {\n            if (volStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Volume is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            VolumeDataStoreVO updateBuilder = _volumeStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _volumeStoreDao.update(volStoreVO.getId(), updateBuilder);\n            \r\n            VolumeVO volUpdater = volumeDao.createForUpdate();\n            volUpdater.setSize(answer.getTemplateSize());\n            volumeDao.update(obj.getId(), volUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to upload volume: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED,\n                    (volStoreVO == null ? -1L : volStoreVO.getZoneId()), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","date":"2018-01-20 05:49:27","endLine":271,"groupId":"24598","id":2,"instanceNumber":2,"isCurCommit":0,"methodName":"createVolumeAsyncCallback","params":"(AsyncCallbackDispatcher<?extendsBaseImageStoreDriverImpl@DownloadAnswer>callback@CreateContext<CreateCmdResult>context)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/1c/6f1e70660fef1a381619b146c4fb04e9c8c32c.src","preCode":"        createVolumeAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback, CreateContext<CreateCmdResult> context) {\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        VolumeDataStoreVO volStoreVO = _volumeStoreDao.findByStoreVolume(store.getId(), obj.getId());\n        if (volStoreVO != null) {\n            if (volStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Volume is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            VolumeDataStoreVO updateBuilder = _volumeStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _volumeStoreDao.update(volStoreVO.getId(), updateBuilder);\n            \r\n            VolumeVO volUpdater = volumeDao.createForUpdate();\n            volUpdater.setSize(answer.getTemplateSize());\n            volumeDao.update(obj.getId(), volUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to upload volume: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED,\n                    (volStoreVO == null ? -1L : volStoreVO.getZoneId()), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","realPath":"engine/storage/src/main/java/org/apache/cloudstack/storage/image/BaseImageStoreDriverImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":224,"status":"B"}],"commitId":"893a88d225276e45f12f9490e6af2c94a81c2965","commitMessage":"@@@CLOUDSTACK-10105: Use maven standard project structure in all projects (#2283)\n\nRemove maven standard module (which only a few were using) and get ride of maven customization for the projects structure.\n\n- moved all directories to src/main/java.  src/main/resources.  src/main/scripts.  src/test/java.  src/test/resources\n- grep scan to search for src/com and src/org left over\n- grep for <project>/scripts to fix pom.xml configuration\n- remove custom <build> configuration in pom.xml\n\nSigned-off-by: Marc-Aur?le Brothier <m@brothier.org>","date":"2018-01-20 05:49:27","modifiedFileCount":"1","status":"B","submitter":"Marc-Aur?le Brothier"},{"authorTime":"2018-01-20 05:49:27","codes":[{"authorDate":"2019-08-09 18:44:46","commitOrder":2,"curCode":"    protected Void createTemplateAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback,\n        CreateContext<CreateCmdResult> context) {\n        if (s_logger.isDebugEnabled()) {\n            s_logger.debug(\"Performing image store createTemplate async callback\");\n        }\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n        List<OVFPropertyTO> ovfProperties = answer.getOvfProperties();\n\n        TemplateDataStoreVO tmpltStoreVO = _templateStoreDao.findByStoreTemplate(store.getId(), obj.getId());\n        if (tmpltStoreVO != null) {\n            if (tmpltStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (CollectionUtils.isNotEmpty(ovfProperties)) {\n                    persistOVFProperties(ovfProperties, obj.getId());\n                }\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Template is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            TemplateDataStoreVO updateBuilder = _templateStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _templateStoreDao.update(tmpltStoreVO.getId(), updateBuilder);\n            \r\n            VMTemplateVO tmlptUpdater = _templateDao.createForUpdate();\n            tmlptUpdater.setSize(answer.getTemplateSize());\n            _templateDao.update(obj.getId(), tmlptUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to register template: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED, _vmTemplateZoneDao.listByTemplateId(obj.getId()).get(0).getZoneId(), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            if (answer.getCheckSum() != null) {\n                VMTemplateVO templateDaoBuilder = _templateDao.createForUpdate();\n                templateDaoBuilder.setChecksum(answer.getCheckSum());\n                _templateDao.update(obj.getId(), templateDaoBuilder);\n            }\n            if (CollectionUtils.isNotEmpty(ovfProperties)) {\n                persistOVFProperties(ovfProperties, obj.getId());\n            }\n\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","date":"2019-08-09 18:44:46","endLine":258,"groupId":"24598","id":3,"instanceNumber":1,"isCurCommit":0,"methodName":"createTemplateAsyncCallback","params":"(AsyncCallbackDispatcher<?extendsBaseImageStoreDriverImpl@DownloadAnswer>callback@CreateContext<CreateCmdResult>context)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/de/c9b76dbc84722e2890b59d2cf189a1b92ea437.src","preCode":"    protected Void createTemplateAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback,\n        CreateContext<CreateCmdResult> context) {\n        if (s_logger.isDebugEnabled()) {\n            s_logger.debug(\"Performing image store createTemplate async callback\");\n        }\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        TemplateDataStoreVO tmpltStoreVO = _templateStoreDao.findByStoreTemplate(store.getId(), obj.getId());\n        if (tmpltStoreVO != null) {\n            if (tmpltStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Template is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            TemplateDataStoreVO updateBuilder = _templateStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _templateStoreDao.update(tmpltStoreVO.getId(), updateBuilder);\n            \r\n            VMTemplateVO tmlptUpdater = _templateDao.createForUpdate();\n            tmlptUpdater.setSize(answer.getTemplateSize());\n            _templateDao.update(obj.getId(), tmlptUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to register template: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED, _vmTemplateZoneDao.listByTemplateId(obj.getId()).get(0).getZoneId(), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            if (answer.getCheckSum() != null) {\n                VMTemplateVO templateDaoBuilder = _templateDao.createForUpdate();\n                templateDaoBuilder.setChecksum(answer.getCheckSum());\n                _templateDao.update(obj.getId(), templateDaoBuilder);\n            }\n\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","realPath":"engine/storage/src/main/java/org/apache/cloudstack/storage/image/BaseImageStoreDriverImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":195,"status":"M"},{"authorDate":"2018-01-20 05:49:27","commitOrder":2,"curCode":"        createVolumeAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback, CreateContext<CreateCmdResult> context) {\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        VolumeDataStoreVO volStoreVO = _volumeStoreDao.findByStoreVolume(store.getId(), obj.getId());\n        if (volStoreVO != null) {\n            if (volStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Volume is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            VolumeDataStoreVO updateBuilder = _volumeStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _volumeStoreDao.update(volStoreVO.getId(), updateBuilder);\n            \r\n            VolumeVO volUpdater = volumeDao.createForUpdate();\n            volUpdater.setSize(answer.getTemplateSize());\n            volumeDao.update(obj.getId(), volUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to upload volume: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED,\n                    (volStoreVO == null ? -1L : volStoreVO.getZoneId()), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","date":"2018-01-20 05:49:27","endLine":271,"groupId":"24598","id":4,"instanceNumber":2,"isCurCommit":0,"methodName":"createVolumeAsyncCallback","params":"(AsyncCallbackDispatcher<?extendsBaseImageStoreDriverImpl@DownloadAnswer>callback@CreateContext<CreateCmdResult>context)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/1c/6f1e70660fef1a381619b146c4fb04e9c8c32c.src","preCode":"        createVolumeAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback, CreateContext<CreateCmdResult> context) {\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        VolumeDataStoreVO volStoreVO = _volumeStoreDao.findByStoreVolume(store.getId(), obj.getId());\n        if (volStoreVO != null) {\n            if (volStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Volume is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            VolumeDataStoreVO updateBuilder = _volumeStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _volumeStoreDao.update(volStoreVO.getId(), updateBuilder);\n            \r\n            VolumeVO volUpdater = volumeDao.createForUpdate();\n            volUpdater.setSize(answer.getTemplateSize());\n            volumeDao.update(obj.getId(), volUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to upload volume: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED,\n                    (volStoreVO == null ? -1L : volStoreVO.getZoneId()), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","realPath":"engine/storage/src/main/java/org/apache/cloudstack/storage/image/BaseImageStoreDriverImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":224,"status":"N"}],"commitId":"3c2af55d81dbfaf17a3bf0b6247ecd830df12996","commitMessage":"@@@vmware: allow configuring appliances on the VM instance wizard when OVF properties are available (#3271)\n\nProblem: In Vmware.  appliances that have options that are required to be answered before deployments are configurable through vSphere vCenter user interface but it is not possible from the CloudStack user interface.\n\nRoot cause: CloudStack does not handle vApp configuration options during deployments if the appliance contains configurable options. These configurations are mandatory for VM deployment from the appliance on Vmware vSphere vCenter. As shown in the image below.  Vmware detects there are mandatory configurations that the administrator must set before deploy the VM from the appliance (in red on the image below):\n\nSolution:\nOn template registration.  after it is downloaded to secondary storage.  the OVF file is examined and OVF properties are extracted from the file when available.\nOVF properties extracted from templates after being downloaded to secondary storage are stored on the new table 'template_ovf_properties'.\nA new optional section is added to the VM deployment wizard in the UI:\nIf the selected template does not contain OVF properties.  then the optional section is not displayed on the wizard.\nIf the selected template contains OVF properties.  then the optional new section is displayed. Each OVF property is displayed and the user must complete every property before proceeding to the next section.\nIf any configuration property is empty.  then a dialog is displayed indicating that there are empty properties which must be set before proceeding\nimage\nThe specific OVF properties set on deployment are stored on the 'user_vm_details' table with the prefix: 'ovfproperties-'.\nThe VM is configured with the vApp configuration section containing the values that the user provided on the wizard.","date":"2019-08-09 18:44:46","modifiedFileCount":"26","status":"M","submitter":"Nicolas Vazquez"},{"authorTime":"2020-10-26 21:24:14","codes":[{"authorDate":"2020-10-26 21:24:14","commitOrder":3,"curCode":"    protected Void createTemplateAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback,\n                                               CreateContext<CreateCmdResult> context) {\n        if (LOGGER.isDebugEnabled()) {\n            LOGGER.debug(\"Performing image store createTemplate async callback\");\n        }\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        VMTemplateVO template = _templateDao.findById(obj.getId());\n        TemplateDataStoreVO tmpltStoreVO = _templateStoreDao.findByStoreTemplate(store.getId(), obj.getId());\n        if (tmpltStoreVO != null) {\n            if (tmpltStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (template.isDeployAsIs()) {\n                    boolean persistDeployAsIs = deployAsIsHelper.persistTemplateDeployAsIsDetails(template.getId(), answer, tmpltStoreVO);\n                    if (!persistDeployAsIs) {\n                        LOGGER.info(\"Failed persisting deploy-as-is template details for template \" + template.getName());\n                        return null;\n                    }\n                }\n                if (LOGGER.isDebugEnabled()) {\n                    LOGGER.debug(\"Template is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            LOGGER.info(\"Updating store ref entry for template \" + template.getName());\n            TemplateDataStoreVO updateBuilder = _templateStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _templateStoreDao.update(tmpltStoreVO.getId(), updateBuilder);\n            \r\n            VMTemplateVO tmlptUpdater = _templateDao.createForUpdate();\n            tmlptUpdater.setSize(answer.getTemplateSize());\n            _templateDao.update(obj.getId(), tmlptUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n                answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to register template: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED, _vmTemplateZoneDao.listByTemplateId(obj.getId()).get(0).getZoneId(), null, msg, msg);\n            LOGGER.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            if (answer.getCheckSum() != null) {\n                VMTemplateVO templateDaoBuilder = _templateDao.createForUpdate();\n                templateDaoBuilder.setChecksum(answer.getCheckSum());\n                _templateDao.update(obj.getId(), templateDaoBuilder);\n            }\n\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","date":"2020-10-26 21:24:14","endLine":258,"groupId":"10815","id":5,"instanceNumber":1,"isCurCommit":0,"methodName":"createTemplateAsyncCallback","params":"(AsyncCallbackDispatcher<?extendsBaseImageStoreDriverImpl@DownloadAnswer>callback@CreateContext<CreateCmdResult>context)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/37/a7985ce6f60e526525ce364f8fb08c383d1580.src","preCode":"    protected Void createTemplateAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback,\n        CreateContext<CreateCmdResult> context) {\n        if (s_logger.isDebugEnabled()) {\n            s_logger.debug(\"Performing image store createTemplate async callback\");\n        }\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n        List<OVFPropertyTO> ovfProperties = answer.getOvfProperties();\n\n        TemplateDataStoreVO tmpltStoreVO = _templateStoreDao.findByStoreTemplate(store.getId(), obj.getId());\n        if (tmpltStoreVO != null) {\n            if (tmpltStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (CollectionUtils.isNotEmpty(ovfProperties)) {\n                    persistOVFProperties(ovfProperties, obj.getId());\n                }\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Template is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            TemplateDataStoreVO updateBuilder = _templateStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _templateStoreDao.update(tmpltStoreVO.getId(), updateBuilder);\n            \r\n            VMTemplateVO tmlptUpdater = _templateDao.createForUpdate();\n            tmlptUpdater.setSize(answer.getTemplateSize());\n            _templateDao.update(obj.getId(), tmlptUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to register template: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED, _vmTemplateZoneDao.listByTemplateId(obj.getId()).get(0).getZoneId(), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            if (answer.getCheckSum() != null) {\n                VMTemplateVO templateDaoBuilder = _templateDao.createForUpdate();\n                templateDaoBuilder.setChecksum(answer.getCheckSum());\n                _templateDao.update(obj.getId(), templateDaoBuilder);\n            }\n            if (CollectionUtils.isNotEmpty(ovfProperties)) {\n                persistOVFProperties(ovfProperties, obj.getId());\n            }\n\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","realPath":"engine/storage/src/main/java/org/apache/cloudstack/storage/image/BaseImageStoreDriverImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":193,"status":"M"},{"authorDate":"2020-10-26 21:24:14","commitOrder":3,"curCode":"    createVolumeAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback, CreateContext<CreateCmdResult> context) {\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        VolumeDataStoreVO volStoreVO = _volumeStoreDao.findByStoreVolume(store.getId(), obj.getId());\n        if (volStoreVO != null) {\n            if (volStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (LOGGER.isDebugEnabled()) {\n                    LOGGER.debug(\"Volume is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            VolumeDataStoreVO updateBuilder = _volumeStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _volumeStoreDao.update(volStoreVO.getId(), updateBuilder);\n            \r\n            VolumeVO volUpdater = volumeDao.createForUpdate();\n            volUpdater.setSize(answer.getTemplateSize());\n            volumeDao.update(obj.getId(), volUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n                answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to upload volume: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED,\n                    (volStoreVO == null ? -1L : volStoreVO.getZoneId()), null, msg, msg);\n            LOGGER.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","date":"2020-10-26 21:24:14","endLine":308,"groupId":"10815","id":6,"instanceNumber":2,"isCurCommit":0,"methodName":"createVolumeAsyncCallback","params":"(AsyncCallbackDispatcher<?extendsBaseImageStoreDriverImpl@DownloadAnswer>callback@CreateContext<CreateCmdResult>context)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/37/a7985ce6f60e526525ce364f8fb08c383d1580.src","preCode":"        createVolumeAsyncCallback(AsyncCallbackDispatcher<? extends BaseImageStoreDriverImpl, DownloadAnswer> callback, CreateContext<CreateCmdResult> context) {\n        DownloadAnswer answer = callback.getResult();\n        DataObject obj = context.data;\n        DataStore store = obj.getDataStore();\n\n        VolumeDataStoreVO volStoreVO = _volumeStoreDao.findByStoreVolume(store.getId(), obj.getId());\n        if (volStoreVO != null) {\n            if (volStoreVO.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n                if (s_logger.isDebugEnabled()) {\n                    s_logger.debug(\"Volume is already in DOWNLOADED state, ignore further incoming DownloadAnswer\");\n                }\n                return null;\n            }\n            VolumeDataStoreVO updateBuilder = _volumeStoreDao.createForUpdate();\n            updateBuilder.setDownloadPercent(answer.getDownloadPct());\n            updateBuilder.setDownloadState(answer.getDownloadStatus());\n            updateBuilder.setLastUpdated(new Date());\n            updateBuilder.setErrorString(answer.getErrorString());\n            updateBuilder.setJobId(answer.getJobId());\n            updateBuilder.setLocalDownloadPath(answer.getDownloadPath());\n            updateBuilder.setInstallPath(answer.getInstallPath());\n            updateBuilder.setSize(answer.getTemplateSize());\n            updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());\n            _volumeStoreDao.update(volStoreVO.getId(), updateBuilder);\n            \r\n            VolumeVO volUpdater = volumeDao.createForUpdate();\n            volUpdater.setSize(answer.getTemplateSize());\n            volumeDao.update(obj.getId(), volUpdater);\n        }\n\n        AsyncCompletionCallback<CreateCmdResult> caller = context.getParentCallback();\n\n        if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR ||\n            answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.ABANDONED || answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.UNKNOWN) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            result.setSuccess(false);\n            result.setResult(answer.getErrorString());\n            caller.complete(result);\n            String msg = \"Failed to upload volume: \" + obj.getUuid() + \" with error: \" + answer.getErrorString();\n            _alertMgr.sendAlert(AlertManager.AlertType.ALERT_TYPE_UPLOAD_FAILED,\n                    (volStoreVO == null ? -1L : volStoreVO.getZoneId()), null, msg, msg);\n            s_logger.error(msg);\n        } else if (answer.getDownloadStatus() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {\n            CreateCmdResult result = new CreateCmdResult(null, null);\n            caller.complete(result);\n        }\n        return null;\n    }\n","realPath":"engine/storage/src/main/java/org/apache/cloudstack/storage/image/BaseImageStoreDriverImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":261,"status":"M"}],"commitId":"1a75872cd484dd387552bae58996a56679fdb51e","commitMessage":"@@@Merge pull request #4307 from shapeblue/ovfprops-and-vsphere-adv-together\n\n[VMware] vSphere advanced capabilities and Full OVF properties support","date":"2020-10-26 21:24:14","modifiedFileCount":"173","status":"M","submitter":"Boris Stoyanov - a.k.a Bobby"}]
