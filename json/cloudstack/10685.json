[{"authorTime":"2018-12-14 19:01:28","codes":[{"authorDate":"2018-12-14 19:01:28","commitOrder":1,"curCode":"    private Map<VolumeInfo, DataStore> configureTestInternalCanHandle(boolean isManagedStorage, StoragePoolType storagePoolType) {\n        VolumeObject volumeInfo = Mockito.spy(new VolumeObject());\n        Mockito.doReturn(0l).when(volumeInfo).getPoolId();\n        DataStore ds = Mockito.spy(new PrimaryDataStoreImpl());\n        Mockito.doReturn(0l).when(ds).getId();\n\n        Map<VolumeInfo, DataStore> volumeMap = new HashMap<>();\n        volumeMap.put(volumeInfo, ds);\n\n        StoragePoolVO storagePool = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(storagePoolType).when(storagePool).getPoolType();\n\n        Mockito.doReturn(storagePool).when(primaryDataStoreDao).findById(0l);\n        Mockito.doReturn(isManagedStorage).when(storagePool).isManaged();\n        return volumeMap;\n    }\n","date":"2018-12-14 19:01:28","endLine":146,"groupId":"21996","id":1,"instanceNumber":1,"isCurCommit":0,"methodName":"configureTestInternalCanHandle","params":"(booleanisManagedStorage@StoragePoolTypestoragePoolType)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/b3/44f83569a40508ed61b1802f2b1c042d62cc72.src","preCode":"    private Map<VolumeInfo, DataStore> configureTestInternalCanHandle(boolean isManagedStorage, StoragePoolType storagePoolType) {\n        VolumeObject volumeInfo = Mockito.spy(new VolumeObject());\n        Mockito.doReturn(0l).when(volumeInfo).getPoolId();\n        DataStore ds = Mockito.spy(new PrimaryDataStoreImpl());\n        Mockito.doReturn(0l).when(ds).getId();\n\n        Map<VolumeInfo, DataStore> volumeMap = new HashMap<>();\n        volumeMap.put(volumeInfo, ds);\n\n        StoragePoolVO storagePool = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(storagePoolType).when(storagePool).getPoolType();\n\n        Mockito.doReturn(storagePool).when(primaryDataStoreDao).findById(0l);\n        Mockito.doReturn(isManagedStorage).when(storagePool).isManaged();\n        return volumeMap;\n    }\n","realPath":"engine/storage/datamotion/src/test/java/org/apache/cloudstack/storage/motion/KvmNonManagedStorageSystemDataMotionTest.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":131,"status":"B"},{"authorDate":"2018-12-14 19:01:28","commitOrder":1,"curCode":"    private void configureAndTestInternalCanHandle(boolean sPool0IsManaged, boolean sPool1IsManaged, StrategyPriority expectedStrategyPriority) {\n        VolumeObject volumeInfo = Mockito.spy(new VolumeObject());\n        Mockito.doReturn(0l).when(volumeInfo).getPoolId();\n\n        DataStore ds = Mockito.spy(new PrimaryDataStoreImpl());\n        Mockito.doReturn(1l).when(ds).getId();\n\n        Map<VolumeInfo, DataStore> volumeMap = new HashMap<>();\n        volumeMap.put(volumeInfo, ds);\n\n        StoragePoolVO storagePool0 = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(sPool0IsManaged).when(storagePool0).isManaged();\n        StoragePoolVO storagePool1 = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(sPool1IsManaged).when(storagePool1).isManaged();\n\n        Mockito.doReturn(storagePool0).when(primaryDataStoreDao).findById(0l);\n        Mockito.doReturn(storagePool1).when(primaryDataStoreDao).findById(1l);\n\n        StrategyPriority strategyPriority = storageSystemDataMotionStrategy.internalCanHandle(volumeMap);\n\n        Assert.assertEquals(expectedStrategyPriority, strategyPriority);\n    }\n","date":"2018-12-14 19:01:28","endLine":142,"groupId":"21996","id":2,"instanceNumber":2,"isCurCommit":0,"methodName":"configureAndTestInternalCanHandle","params":"(booleansPool0IsManaged@booleansPool1IsManaged@StrategyPriorityexpectedStrategyPriority)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/d7/6ff272830cc0b3d7499fe695139e9f28f3cf09.src","preCode":"    private void configureAndTestInternalCanHandle(boolean sPool0IsManaged, boolean sPool1IsManaged, StrategyPriority expectedStrategyPriority) {\n        VolumeObject volumeInfo = Mockito.spy(new VolumeObject());\n        Mockito.doReturn(0l).when(volumeInfo).getPoolId();\n\n        DataStore ds = Mockito.spy(new PrimaryDataStoreImpl());\n        Mockito.doReturn(1l).when(ds).getId();\n\n        Map<VolumeInfo, DataStore> volumeMap = new HashMap<>();\n        volumeMap.put(volumeInfo, ds);\n\n        StoragePoolVO storagePool0 = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(sPool0IsManaged).when(storagePool0).isManaged();\n        StoragePoolVO storagePool1 = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(sPool1IsManaged).when(storagePool1).isManaged();\n\n        Mockito.doReturn(storagePool0).when(primaryDataStoreDao).findById(0l);\n        Mockito.doReturn(storagePool1).when(primaryDataStoreDao).findById(1l);\n\n        StrategyPriority strategyPriority = storageSystemDataMotionStrategy.internalCanHandle(volumeMap);\n\n        Assert.assertEquals(expectedStrategyPriority, strategyPriority);\n    }\n","realPath":"engine/storage/datamotion/src/test/java/org/apache/cloudstack/storage/motion/StorageSystemDataMotionStrategyTest.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":121,"status":"B"}],"commitId":"bf209405e7d60b6a5abf87677d368c429359d98a","commitMessage":"@@@Allow KVM VM live migration with ROOT volume on file storage type (#2997)\n\n* Allow KVM VM live migration with ROOT volume on file\n\n* Allow KVM VM live migration with ROOT volume on file\n- Add JUnit tests\n\n* Address reviewers and change some variable names to ease future\nimplementation (developers can easily guess the name and use\nautocomplete)\n","date":"2018-12-14 19:01:28","modifiedFileCount":"14","status":"B","submitter":"Gabriel Beims Br?scher"},{"authorTime":"2019-06-10 18:05:26","codes":[{"authorDate":"2018-12-14 19:01:28","commitOrder":2,"curCode":"    private Map<VolumeInfo, DataStore> configureTestInternalCanHandle(boolean isManagedStorage, StoragePoolType storagePoolType) {\n        VolumeObject volumeInfo = Mockito.spy(new VolumeObject());\n        Mockito.doReturn(0l).when(volumeInfo).getPoolId();\n        DataStore ds = Mockito.spy(new PrimaryDataStoreImpl());\n        Mockito.doReturn(0l).when(ds).getId();\n\n        Map<VolumeInfo, DataStore> volumeMap = new HashMap<>();\n        volumeMap.put(volumeInfo, ds);\n\n        StoragePoolVO storagePool = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(storagePoolType).when(storagePool).getPoolType();\n\n        Mockito.doReturn(storagePool).when(primaryDataStoreDao).findById(0l);\n        Mockito.doReturn(isManagedStorage).when(storagePool).isManaged();\n        return volumeMap;\n    }\n","date":"2018-12-14 19:01:28","endLine":146,"groupId":"10685","id":3,"instanceNumber":1,"isCurCommit":0,"methodName":"configureTestInternalCanHandle","params":"(booleanisManagedStorage@StoragePoolTypestoragePoolType)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/b3/44f83569a40508ed61b1802f2b1c042d62cc72.src","preCode":"    private Map<VolumeInfo, DataStore> configureTestInternalCanHandle(boolean isManagedStorage, StoragePoolType storagePoolType) {\n        VolumeObject volumeInfo = Mockito.spy(new VolumeObject());\n        Mockito.doReturn(0l).when(volumeInfo).getPoolId();\n        DataStore ds = Mockito.spy(new PrimaryDataStoreImpl());\n        Mockito.doReturn(0l).when(ds).getId();\n\n        Map<VolumeInfo, DataStore> volumeMap = new HashMap<>();\n        volumeMap.put(volumeInfo, ds);\n\n        StoragePoolVO storagePool = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(storagePoolType).when(storagePool).getPoolType();\n\n        Mockito.doReturn(storagePool).when(primaryDataStoreDao).findById(0l);\n        Mockito.doReturn(isManagedStorage).when(storagePool).isManaged();\n        return volumeMap;\n    }\n","realPath":"engine/storage/datamotion/src/test/java/org/apache/cloudstack/storage/motion/KvmNonManagedStorageSystemDataMotionTest.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":131,"status":"N"},{"authorDate":"2019-06-10 18:05:26","commitOrder":2,"curCode":"    private void configureAndTestInternalCanHandle(boolean sPool0IsManaged, boolean sPool1IsManaged, StrategyPriority expectedStrategyPriority) {\n        VolumeObject volumeInfo = Mockito.spy(new VolumeObject());\n        Mockito.doReturn(0l).when(volumeInfo).getPoolId();\n\n        DataStore ds = Mockito.spy(new PrimaryDataStoreImpl());\n        Mockito.doReturn(1l).when(ds).getId();\n\n        Map<VolumeInfo, DataStore> volumeMap = new HashMap<>();\n        volumeMap.put(volumeInfo, ds);\n\n        StoragePoolVO storagePool0 = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(sPool0IsManaged).when(storagePool0).isManaged();\n        StoragePoolVO storagePool1 = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(sPool1IsManaged).when(storagePool1).isManaged();\n\n        Mockito.doReturn(storagePool0).when(primaryDataStoreDao).findById(0l);\n        Mockito.doReturn(storagePool1).when(primaryDataStoreDao).findById(1l);\n\n        StrategyPriority strategyPriority = strategy.internalCanHandle(volumeMap, new HostVO(\"srcHostUuid\"), new HostVO(\"destHostUuid\"));\n\n        Assert.assertEquals(expectedStrategyPriority, strategyPriority);\n    }\n","date":"2019-06-10 18:05:26","endLine":141,"groupId":"10685","id":4,"instanceNumber":2,"isCurCommit":0,"methodName":"configureAndTestInternalCanHandle","params":"(booleansPool0IsManaged@booleansPool1IsManaged@StrategyPriorityexpectedStrategyPriority)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/1b/383d91574c93b77bc370631f1158dede4afb62.src","preCode":"    private void configureAndTestInternalCanHandle(boolean sPool0IsManaged, boolean sPool1IsManaged, StrategyPriority expectedStrategyPriority) {\n        VolumeObject volumeInfo = Mockito.spy(new VolumeObject());\n        Mockito.doReturn(0l).when(volumeInfo).getPoolId();\n\n        DataStore ds = Mockito.spy(new PrimaryDataStoreImpl());\n        Mockito.doReturn(1l).when(ds).getId();\n\n        Map<VolumeInfo, DataStore> volumeMap = new HashMap<>();\n        volumeMap.put(volumeInfo, ds);\n\n        StoragePoolVO storagePool0 = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(sPool0IsManaged).when(storagePool0).isManaged();\n        StoragePoolVO storagePool1 = Mockito.spy(new StoragePoolVO());\n        Mockito.doReturn(sPool1IsManaged).when(storagePool1).isManaged();\n\n        Mockito.doReturn(storagePool0).when(primaryDataStoreDao).findById(0l);\n        Mockito.doReturn(storagePool1).when(primaryDataStoreDao).findById(1l);\n\n        StrategyPriority strategyPriority = storageSystemDataMotionStrategy.internalCanHandle(volumeMap);\n\n        Assert.assertEquals(expectedStrategyPriority, strategyPriority);\n    }\n","realPath":"engine/storage/datamotion/src/test/java/org/apache/cloudstack/storage/motion/StorageSystemDataMotionStrategyTest.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":120,"status":"M"}],"commitId":"0fbf5006b87b6c5bc6188e3e1dd226a98c3bb453","commitMessage":"@@@kvm: live storage migration intra cluster from NFS source and destination (#2983)\n\nFeature Specification: https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=95653548\n\nLive storage migration on KVM under these conditions:\n\nFrom source and destination hosts within the same cluster\nFrom NFS primary storage to NFS cluster-wide primary storage\nSource NFS and destination NFS storage mounted on hosts\nIn order to enable this functionality.  database should be updated in order to enable live storage capacibilty for KVM.  if previous conditions are met. This is due to existing conflicts between qemu and libvirt versions. This has been tested on CentOS 6 hosts.\n\nAdditional notes:\n\nTo use this feature set the storage_motion_supported=1 in the hypervisor_capability table for KVM. This is done by default as the feature may not work in some environments.  read below.\nThis feature of online storage+VM migration for KVM will only work with CentOS6 and possible Ubuntu as KVM hosts but not with CentOS7 due to:\nhttps://bugs.centos.org/view.php?id=14026\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1219541\nOn CentOS7 the error we see is: \" error: unable to execute QEMU command 'migrate': this feature or command is not currently supported\" (reference https://ask.openstack.org/en/question/94186/live-migration-unable-to-execute-qemu-command-migrate/). Reading through various lists looks like the migrate feature with qemu may be available with paid versions of RHEL-EV but not centos7 however this works with CentOS6.\nFix for CentOS 7:\n\nCreate repo file on /etc/yum.repos.d/:\n[qemu-kvm-rhev]\nname=oVirt rebuilds of qemu-kvm-rhev\nbaseurl=http://resources.ovirt.org/pub/ovirt-3.5/rpm/el7Server/\nmirrorlist=http://resources.ovirt.org/pub/yum-repo/mirrorlist-ovirt-3.5-el7Server\nenabled=1\nskip_if_unavailable=1\ngpgcheck=0\nyum install qemu-kvm-common-ev-2.3.0-29.1.el7.x86_64 qemu-kvm-ev-2.3.0-29.1.el7.x86_64 qemu-img-ev-2.3.0-29.1.el7.x86_64\nReboot host\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>","date":"2019-06-10 18:05:26","modifiedFileCount":"25","status":"M","submitter":"Nicolas Vazquez"}]
