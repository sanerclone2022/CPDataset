[{"authorTime":"2018-01-20 05:49:27","codes":[{"authorDate":"2018-01-20 05:49:27","commitOrder":1,"curCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findById(vm.getTemplateId());\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                                                  vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                                                  vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                                                      Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                                                      volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                                                      volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                                                  vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                                                  VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n            });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                        + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                                                                newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                                                                null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                                                                null, null, true, null, null);\n                            \r\n                            if (requiredOfferings.get(0).getIsPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                            + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","date":"2018-01-20 05:49:27","endLine":5997,"groupId":"9480","id":1,"instanceNumber":1,"isCurCommit":0,"methodName":"moveVMToUser","params":"(finalAssignVMCmdcmd)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/da/b741c3c274ded6ea2d8ba461cb81d920542cb3.src","preCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findById(vm.getTemplateId());\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                                                  vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                                                  vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                                                      Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                                                      volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                                                      volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                                                  vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                                                  VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n            });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                        + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                                                                newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                                                                null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                                                                null, null, true, null, null);\n                            \r\n                            if (requiredOfferings.get(0).getIsPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                            + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","realPath":"server/src/main/java/com/cloud/vm/UserVmManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":5515,"status":"B"},{"authorDate":"2018-01-20 05:49:27","commitOrder":1,"curCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).getIsPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","date":"2018-01-20 05:49:27","endLine":1757,"groupId":"25671","id":2,"instanceNumber":2,"isCurCommit":0,"methodName":"associateIpAddressListToAccount","params":"(longuserId@finallongaccountId@finallongzoneId@finalLongvlanId@finalNetworkguestNetworkFinal)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/c0/0359c92f008cbc5e83df80b963434e7416ac5f.src","preCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).getIsPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","realPath":"server/src/main/java/com/cloud/network/IpAddressManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":1630,"status":"B"}],"commitId":"893a88d225276e45f12f9490e6af2c94a81c2965","commitMessage":"@@@CLOUDSTACK-10105: Use maven standard project structure in all projects (#2283)\n\nRemove maven standard module (which only a few were using) and get ride of maven customization for the projects structure.\n\n- moved all directories to src/main/java.  src/main/resources.  src/main/scripts.  src/test/java.  src/test/resources\n- grep scan to search for src/com and src/org left over\n- grep for <project>/scripts to fix pom.xml configuration\n- remove custom <build> configuration in pom.xml\n\nSigned-off-by: Marc-Aur?le Brothier <m@brothier.org>","date":"2018-01-20 05:49:27","modifiedFileCount":"1","status":"B","submitter":"Marc-Aur?le Brothier"},{"authorTime":"2018-09-22 23:20:48","codes":[{"authorDate":"2018-09-22 23:20:48","commitOrder":2,"curCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findById(vm.getTemplateId());\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","date":"2018-09-22 23:20:48","endLine":5991,"groupId":"9480","id":3,"instanceNumber":1,"isCurCommit":0,"methodName":"moveVMToUser","params":"(finalAssignVMCmdcmd)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/8d/bdf4bd862c76d5243ed3a85344222c16528eae.src","preCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findById(vm.getTemplateId());\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null);\n                            \r\n                            if (requiredOfferings.get(0).getIsPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","realPath":"server/src/main/java/com/cloud/vm/UserVmManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":5509,"status":"M"},{"authorDate":"2018-09-22 23:20:48","commitOrder":2,"curCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","date":"2018-09-22 23:20:48","endLine":1765,"groupId":"25671","id":4,"instanceNumber":2,"isCurCommit":0,"methodName":"associateIpAddressListToAccount","params":"(longuserId@finallongaccountId@finallongzoneId@finalLongvlanId@finalNetworkguestNetworkFinal)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/cb/7210d33acfe12ba1b3926dbe86c72f63bd28da.src","preCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).getIsPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","realPath":"server/src/main/java/com/cloud/network/IpAddressManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":1638,"status":"M"}],"commitId":"d53fc944857eb6e6d9542eef915f14066dab5861","commitMessage":"@@@CLOUDSTACK-10365: Change the \"getXXX\" boolean method names to \"isXXX\" (#2847)\n\nThese boolean-return methods are named as \"getXXX\".\nOther boolean-return methods are named as \"isXXX\".\nConsidering there methods will return boolean values.  it should be more clear and consistent to rename them as \"isXXX\".\n(rebase #2602 and #2816)\n","date":"2018-09-22 23:20:48","modifiedFileCount":"77","status":"M","submitter":"Kui LIU"},{"authorTime":"2018-09-22 23:20:48","codes":[{"authorDate":"2020-01-30 17:36:50","commitOrder":3,"curCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findById(vm.getTemplateId());\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","date":"2020-01-30 17:36:50","endLine":6543,"groupId":"4685","id":5,"instanceNumber":1,"isCurCommit":0,"methodName":"moveVMToUser","params":"(finalAssignVMCmdcmd)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/a1/55d8e977c88596839e518405e05477beda52be.src","preCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findById(vm.getTemplateId());\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","realPath":"server/src/main/java/com/cloud/vm/UserVmManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":6057,"status":"M"},{"authorDate":"2018-09-22 23:20:48","commitOrder":3,"curCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","date":"2018-09-22 23:20:48","endLine":1765,"groupId":"25671","id":6,"instanceNumber":2,"isCurCommit":0,"methodName":"associateIpAddressListToAccount","params":"(longuserId@finallongaccountId@finallongzoneId@finalLongvlanId@finalNetworkguestNetworkFinal)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/cb/7210d33acfe12ba1b3926dbe86c72f63bd28da.src","preCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","realPath":"server/src/main/java/com/cloud/network/IpAddressManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":1638,"status":"N"}],"commitId":"ac581d1546750a6ffc49ebab180e1b80bec4319e","commitMessage":"@@@New feature: Resource count (CPU/RAM) take only running vms into calculation (#3760)\n\n* marvin: check resource count of more types\n\n* New feature: add flag resource.count.running.vms.only to count resource consumption of only running vms\n\nStopped VMs do not use CPU/RAM actually.\nA new global configuration resource.count.running.vms.only is added to determine whether resource (cpu/memory) of only running vms (including Starting/Stopping) will be taken into calculation of resource consumption.\n\n* Add integration test for resource count of only running vms\n","date":"2020-01-30 17:36:50","modifiedFileCount":"11","status":"M","submitter":"Wei Zhou"},{"authorTime":"2018-09-22 23:20:48","codes":[{"authorDate":"2020-02-03 22:43:52","commitOrder":4,"curCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","date":"2020-02-03 22:43:52","endLine":6575,"groupId":"4685","id":7,"instanceNumber":1,"isCurCommit":0,"methodName":"moveVMToUser","params":"(finalAssignVMCmdcmd)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/57/26377d24e0fcfbd5e0ac54db5a259d078a83b4.src","preCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findById(vm.getTemplateId());\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","realPath":"server/src/main/java/com/cloud/vm/UserVmManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":6086,"status":"M"},{"authorDate":"2018-09-22 23:20:48","commitOrder":4,"curCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","date":"2018-09-22 23:20:48","endLine":1765,"groupId":"25671","id":8,"instanceNumber":2,"isCurCommit":0,"methodName":"associateIpAddressListToAccount","params":"(longuserId@finallongaccountId@finallongzoneId@finalLongvlanId@finalNetworkguestNetworkFinal)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/cb/7210d33acfe12ba1b3926dbe86c72f63bd28da.src","preCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","realPath":"server/src/main/java/com/cloud/network/IpAddressManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":1638,"status":"N"}],"commitId":"0f5b0e67f86731b7bfe6fb4728f3c675f54e89da","commitMessage":"@@@VM ingestion (#3606)\n\nThe VM ingestion feature allows CloudStack to discover.  on-board.  import existing VMs in an infra. The feature currently works only for VMware.  with a hypervisor agnostic framework which may be extended for KVM and XenServer in future.\n","date":"2020-02-03 22:43:52","modifiedFileCount":"27","status":"M","submitter":"Abhishek Kumar"},{"authorTime":"2020-02-07 22:43:01","codes":[{"authorDate":"2020-02-07 22:43:01","commitOrder":5,"curCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","date":"2020-02-07 22:43:01","endLine":6570,"groupId":"4685","id":9,"instanceNumber":1,"isCurCommit":0,"methodName":"moveVMToUser","params":"(finalAssignVMCmdcmd)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/ad/2e453080eafa0d1b5fc63d631e1527daf3ae4e.src","preCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","realPath":"server/src/main/java/com/cloud/vm/UserVmManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":6081,"status":"M"},{"authorDate":"2020-02-07 22:43:01","commitOrder":5,"curCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","date":"2020-02-07 22:43:01","endLine":1775,"groupId":"22576","id":10,"instanceNumber":2,"isCurCommit":0,"methodName":"associateIpAddressListToAccount","params":"(longuserId@finallongaccountId@finallongzoneId@finalLongvlanId@finalNetworkguestNetworkFinal)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/40/9b88f53c4f7f7169b29b7434b37dfee9c79a5c.src","preCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","realPath":"server/src/main/java/com/cloud/network/IpAddressManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":1648,"status":"M"}],"commitId":"ce896a477de31e530b4f28ae62fa42d9e0f1635c","commitMessage":"@@@[Vmware] Enable PVLAN support on L2 networks (#3732)\n\n* Enable PVLAN support on L2 networks\n\n* Fix prevent null pointer on details\n\n* Add marvin tests\n\n* Fixes from comments\n\n* Fix: missing pvlan type on plugniccommand\n\n* Fix checks on network creation for vlans overlap\n\n* Fix remove prefix from secondary vlan id\n\n* Improve checks on physical network for pvlans\n\n* Fix compatibility with previous pvlan creation\n\n* Fix shared networks backwards pvlan compatibility\n\n* Add ui fix for pvlan type not passed to api\n\n* Add check for isolated vlan id overlap\n\n* Include check for dynamic vlan reserved for secondary vlan\n\n* Fix marvin tests errors\n\n* Fix redundant imports\n\n* Skip marvin test for pvlan if dvswitch is not present\n\n* spelling\n\nCo-authored-by: Andrija Panic <45762285+andrijapanicsb@users.noreply.github.com>\n","date":"2020-02-07 22:43:01","modifiedFileCount":"23","status":"M","submitter":"Nicolas Vazquez"},{"authorTime":"2020-02-07 22:43:01","codes":[{"authorDate":"2020-09-01 16:28:42","commitOrder":6,"curCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        if (cmd.getProjectId() != null && cmd.getDomainId() == null) {\n            throw new InvalidParameterValueException(\"Please provide a valid domain ID; cannot assign VM to a project if domain ID is NULL.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","date":"2020-09-01 16:28:42","endLine":6587,"groupId":"4685","id":11,"instanceNumber":1,"isCurCommit":0,"methodName":"moveVMToUser","params":"(finalAssignVMCmdcmd)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/f9/9a0663e298f7c0127141bfbce555bff3cd74bf.src","preCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","realPath":"server/src/main/java/com/cloud/vm/UserVmManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":6094,"status":"M"},{"authorDate":"2020-02-07 22:43:01","commitOrder":6,"curCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","date":"2020-02-07 22:43:01","endLine":1775,"groupId":"22576","id":12,"instanceNumber":2,"isCurCommit":0,"methodName":"associateIpAddressListToAccount","params":"(longuserId@finallongaccountId@finallongzoneId@finalLongvlanId@finalNetworkguestNetworkFinal)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/40/9b88f53c4f7f7169b29b7434b37dfee9c79a5c.src","preCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","realPath":"server/src/main/java/com/cloud/network/IpAddressManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":1648,"status":"N"}],"commitId":"d5acabdbf7c2b49db3bc35f8434724b9a979843b","commitMessage":"@@@server: Avoid Null pointer at DomainChecker and enhance AssignVMCmd (#4279)\n\nWhen executing request assignVirtualMachine with null domainID and a valid projectID then a NullPointerException happens at DomainChecker.java.\n\nCommand example:\n\nassign virtualmachine virtualmachineid=vmID projectid=projectID account=admin\nThe NullPointerException that is thrown at DomainChecker is handled at AssignVMCmd.java#L142.  resulting in the following log message: Failed to move vm null.","date":"2020-09-01 16:28:42","modifiedFileCount":"3","status":"M","submitter":"Gabriel Beims Br?scher"},{"authorTime":"2020-02-07 22:43:01","codes":[{"authorDate":"2021-02-01 17:58:52","commitOrder":7,"curCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        if (cmd.getProjectId() != null && cmd.getDomainId() == null) {\n            throw new InvalidParameterValueException(\"Please provide a valid domain ID; cannot assign VM to a project if domain ID is NULL.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.removeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            Set<NetworkVO> applicableNetworks = new LinkedHashSet<>();\n            Map<Long, String> requestedIPv4ForNics = new HashMap<>();\n            Map<Long, String> requestedIPv6ForNics = new HashMap<>();\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","date":"2021-02-01 17:58:52","endLine":6784,"groupId":"8564","id":13,"instanceNumber":1,"isCurCommit":0,"methodName":"moveVMToUser","params":"(finalAssignVMCmdcmd)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/28/6fe2ec903f53020a8d6ac704510e357298592b.src","preCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        if (cmd.getProjectId() != null && cmd.getDomainId() == null) {\n            throw new InvalidParameterValueException(\"Please provide a valid domain ID; cannot assign VM to a project if domain ID is NULL.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.expungeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                String requestedIPv4ForDefaultNic = null;\n                String requestedIPv6ForDefaultNic = null;\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                                requestedIPv4ForDefaultNic = defaultNicOld.getIPv4Address();\n                                requestedIPv6ForDefaultNic = defaultNicOld.getIPv6Address();\n                                s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + requestedIPv4ForDefaultNic + \" on default nic of vm:\" + vm.getInstanceName());\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNic.setRequestedIPv4(requestedIPv4ForDefaultNic);\n                        defaultNic.setRequestedIPv6(requestedIPv6ForDefaultNic);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                Set<NetworkVO> applicableNetworks = new HashSet<NetworkVO>();\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (defaultNetworkOld != null && defaultNetworkOld.getGuestType() == Network.GuestType.Shared && defaultNetworkOld.getAclType() == ACLType.Domain) {\n                            try {\n                                _networkModel.checkNetworkPermissions(newAccount, defaultNetworkOld);\n                                applicableNetworks.add(defaultNetworkOld);\n                            } catch (PermissionDeniedException e) {\n                                s_logger.debug(\"AssignVM: the shared network on old default nic can not be applied to new account\");\n                            }\n                        }\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.expungeNics(vmOldProfile);\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","realPath":"server/src/main/java/com/cloud/vm/UserVmManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":6276,"status":"M"},{"authorDate":"2020-02-07 22:43:01","commitOrder":7,"curCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","date":"2020-02-07 22:43:01","endLine":1775,"groupId":"22576","id":14,"instanceNumber":2,"isCurCommit":0,"methodName":"associateIpAddressListToAccount","params":"(longuserId@finallongaccountId@finallongzoneId@finalLongvlanId@finalNetworkguestNetworkFinal)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/40/9b88f53c4f7f7169b29b7434b37dfee9c79a5c.src","preCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","realPath":"server/src/main/java/com/cloud/network/IpAddressManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":1648,"status":"N"}],"commitId":"ff376d8187ec2687fef06c611740e8d4befba6e7","commitMessage":"@@@Merge release branch 4.15 to master\n\n* 4.15:\n  server: select root disk based on user input during vm import (#4591)\n  kvm: Use Q35 chipset for UEFI x86_64 (#4576)\n  server: fix wrong error message when create isolated network without SourceNat (#4624)\n  server: add possibility to scale vm to current customer offerings (#4622)\n  server: keep networks order and ips while move a vm with multiple networks (#4602)\n  server: throw exception when update vm nic on L2 network (#4625)\n  doc: fix typo in install notes (#4633)\n","date":"2021-02-01 17:58:52","modifiedFileCount":"7","status":"M","submitter":"Daan Hoogland"},{"authorTime":"2021-02-18 16:24:09","codes":[{"authorDate":"2021-02-18 16:24:09","commitOrder":8,"curCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        if (cmd.getProjectId() != null && cmd.getDomainId() == null) {\n            throw new InvalidParameterValueException(\"Please provide a valid domain ID; cannot assign VM to a project if domain ID is NULL.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.removeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            Set<NetworkVO> applicableNetworks = new LinkedHashSet<>();\n            Map<Long, String> requestedIPv4ForNics = new HashMap<>();\n            Map<Long, String> requestedIPv6ForNics = new HashMap<>();\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null, null, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","date":"2021-02-18 16:24:09","endLine":6840,"groupId":"8564","id":15,"instanceNumber":1,"isCurCommit":0,"methodName":"moveVMToUser","params":"(finalAssignVMCmdcmd)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/8a/363c296b70ac7c43224932594923f02202ac69.src","preCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        if (cmd.getProjectId() != null && cmd.getDomainId() == null) {\n            throw new InvalidParameterValueException(\"Please provide a valid domain ID; cannot assign VM to a project if domain ID is NULL.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.removeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            Set<NetworkVO> applicableNetworks = new LinkedHashSet<>();\n            Map<Long, String> requestedIPv4ForNics = new HashMap<>();\n            Map<Long, String> requestedIPv6ForNics = new HashMap<>();\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","realPath":"server/src/main/java/com/cloud/vm/UserVmManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":6332,"status":"M"},{"authorDate":"2021-02-18 16:24:09","commitOrder":8,"curCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null, null, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","date":"2021-02-18 16:24:09","endLine":1818,"groupId":"19386","id":16,"instanceNumber":2,"isCurCommit":0,"methodName":"associateIpAddressListToAccount","params":"(longuserId@finallongaccountId@finallongzoneId@finalLongvlanId@finalNetworkguestNetworkFinal)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/51/af56a887a20dd4a8ab1b428a978173356acec0.src","preCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","realPath":"server/src/main/java/com/cloud/network/IpAddressManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":1691,"status":"M"}],"commitId":"aa01580381c931512d62edbc658865f776ce2efa","commitMessage":"@@@network: Specify IP for VR in shared networks (#4503)\n\nThis PR enables admins to specify IP for a VR in a shared network.","date":"2021-02-18 16:24:09","modifiedFileCount":"16","status":"M","submitter":"Pearl Dsilva"},{"authorTime":"2021-02-18 16:24:09","codes":[{"authorDate":"2021-09-24 12:21:16","commitOrder":9,"curCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        if (cmd.getProjectId() != null && cmd.getDomainId() == null) {\n            throw new InvalidParameterValueException(\"Please provide a valid domain ID; cannot assign VM to a project if domain ID is NULL.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResourceCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResourceCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.removeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            Set<NetworkVO> applicableNetworks = new LinkedHashSet<>();\n            Map<Long, String> requestedIPv4ForNics = new HashMap<>();\n            Map<Long, String> requestedIPv6ForNics = new HashMap<>();\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null, null, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","date":"2021-09-24 12:21:16","endLine":7136,"groupId":"101355","id":17,"instanceNumber":1,"isCurCommit":1,"methodName":"moveVMToUser","params":"(finalAssignVMCmdcmd)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/e9/7526766ba5ac5842c61590d9d8633968437f51.src","preCode":"    public UserVm moveVMToUser(final AssignVMCmd cmd) throws ResourceAllocationException, ConcurrentOperationException, ResourceUnavailableException, InsufficientCapacityException {\n        \r\n\n        \r\n        Account caller = CallContext.current().getCallingAccount();\n        if (!_accountMgr.isRootAdmin(caller.getId())\n                && !_accountMgr.isDomainAdmin(caller.getId())) { \r\n            \r\n            \r\n            \r\n            \r\n            \r\n            throw new InvalidParameterValueException(\"Only domain admins are allowed to assign VMs and not \" + caller.getType());\n        }\n\n        \r\n        final UserVmVO vm = _vmDao.findById(cmd.getVmId());\n        if (vm == null) {\n            throw new InvalidParameterValueException(\"There is no vm by that id \" + cmd.getVmId());\n        } else if (vm.getState() == State.Running) { \r\n            \r\n            if (s_logger.isDebugEnabled()) {\n                s_logger.debug(\"VM is Running, unable to move the vm \" + vm);\n            }\n            InvalidParameterValueException ex = new InvalidParameterValueException(\"VM is Running, unable to move the vm with specified vmId\");\n            ex.addProxyObject(vm.getUuid(), \"vmId\");\n            throw ex;\n        }\n\n        final Account oldAccount = _accountService.getActiveAccountById(vm.getAccountId());\n        if (oldAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid account for VM \" + vm.getAccountId() + \" in domain.\");\n        }\n        final Account newAccount = _accountMgr.finalizeOwner(caller, cmd.getAccountName(), cmd.getDomainId(), cmd.getProjectId());\n        if (newAccount == null) {\n            throw new InvalidParameterValueException(\"Invalid accountid=\" + cmd.getAccountName() + \" in domain \" + cmd.getDomainId());\n        }\n\n        if (newAccount.getState() == Account.State.disabled) {\n            throw new InvalidParameterValueException(\"The new account owner \" + cmd.getAccountName() + \" is disabled.\");\n        }\n\n        if (cmd.getProjectId() != null && cmd.getDomainId() == null) {\n            throw new InvalidParameterValueException(\"Please provide a valid domain ID; cannot assign VM to a project if domain ID is NULL.\");\n        }\n\n        \r\n        _accountMgr.checkAccess(caller, null, true, oldAccount);\n        _accountMgr.checkAccess(caller, null, true, newAccount);\n\n        \r\n        if (oldAccount.getAccountId() == newAccount.getAccountId()) {\n            throw new InvalidParameterValueException(\"The new account is the same as the old account. Account id =\" + oldAccount.getAccountId());\n        }\n\n        \r\n        \r\n        List<PortForwardingRuleVO> pfrules = _portForwardingDao.listByVm(cmd.getVmId());\n        if (pfrules != null && pfrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the Port forwarding rules for this VM before assigning to another user.\");\n        }\n        List<FirewallRuleVO> snrules = _rulesDao.listStaticNatByVmId(vm.getId());\n        if (snrules != null && snrules.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the StaticNat rules for this VM before assigning to another user.\");\n        }\n        List<LoadBalancerVMMapVO> maps = _loadBalancerVMMapDao.listByInstanceId(vm.getId());\n        if (maps != null && maps.size() > 0) {\n            throw new InvalidParameterValueException(\"Remove the load balancing rules for this VM before assigning to another user.\");\n        }\n        \r\n        List<IPAddressVO> ips = _ipAddressDao.findAllByAssociatedVmId(cmd.getVmId());\n        for (IPAddressVO ip : ips) {\n            if (ip.isOneToOneNat()) {\n                throw new InvalidParameterValueException(\"Remove the one to one nat rule for this VM for ip \" + ip.toString());\n            }\n        }\n\n        final List<VolumeVO> volumes = _volsDao.findByInstance(cmd.getVmId());\n\n        for (VolumeVO volume : volumes) {\n            List<SnapshotVO> snapshots = _snapshotDao.listByStatusNotIn(volume.getId(), Snapshot.State.Destroyed,Snapshot.State.Error);\n            if (snapshots != null && snapshots.size() > 0) {\n                throw new InvalidParameterValueException(\n                        \"Snapshots exists for volume: \"+ volume.getName()+ \", Detach volume or remove snapshots for volume before assigning VM to another user.\");\n            }\n        }\n\n        DataCenterVO zone = _dcDao.findById(vm.getDataCenterId());\n\n        \r\n        final ServiceOfferingVO offering = _serviceOfferingDao.findByIdIncludingRemoved(vm.getId(), vm.getServiceOfferingId());\n\n        \r\n        removeInstanceFromInstanceGroup(cmd.getVmId());\n\n        \r\n        if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n            resourceLimitCheck(newAccount, vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n        }\n\n        \r\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.volume, _volsDao.findByInstance(cmd.getVmId()).size());\n        Long totalVolumesSize = (long)0;\n        for (VolumeVO volume : volumes) {\n            totalVolumesSize += volume.getSize();\n        }\n        _resourceLimitMgr.checkResourceLimit(newAccount, ResourceType.primary_storage, totalVolumesSize);\n\n        \r\n        VirtualMachineTemplate template = _templateDao.findByIdIncludingRemoved(vm.getTemplateId());\n        if (template == null) {\n            throw new InvalidParameterValueException(String.format(\"Template for VM: %s cannot be found\", vm.getUuid()));\n        }\n        if (!template.isPublicTemplate()) {\n            Account templateOwner = _accountMgr.getAccount(template.getAccountId());\n            _accountMgr.checkAccess(newAccount, null, true, templateOwner);\n        }\n\n        \r\n        DomainVO domain = _domainDao.findById(cmd.getDomainId());\n        _accountMgr.checkAccess(newAccount, domain);\n\n        Transaction.execute(new TransactionCallbackNoReturn() {\n            @Override\n            public void doInTransactionWithoutResult(TransactionStatus status) {\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DESTROY, vm.getAccountId(), vm.getDataCenterId(),\n                        vm.getId(), vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(),\n                        vm.getHypervisorType().toString(), VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n                \r\n                resourceCountDecrement(oldAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n\n                \r\n                vm.setAccountId(newAccount.getAccountId());\n                vm.setDomainId(cmd.getDomainId());\n                _vmDao.persist(vm);\n\n                \r\n                for (VolumeVO volume : volumes) {\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_DELETE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            Volume.class.getName(), volume.getUuid(), volume.isDisplayVolume());\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.decrementResourceCount(oldAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    volume.setAccountId(newAccount.getAccountId());\n                    volume.setDomainId(newAccount.getDomainId());\n                    _volsDao.persist(volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.volume);\n                    _resourceLimitMgr.incrementResourceCount(newAccount.getAccountId(), ResourceType.primary_storage, new Long(volume.getSize()));\n                    UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VOLUME_CREATE, volume.getAccountId(), volume.getDataCenterId(), volume.getId(), volume.getName(),\n                            volume.getDiskOfferingId(), volume.getTemplateId(), volume.getSize(), Volume.class.getName(),\n                            volume.getUuid(), volume.isDisplayVolume());\n                }\n\n                \r\n                if (! VirtualMachineManager.ResoureCountRunningVMsonly.value()) {\n                    resourceCountIncrement(newAccount.getAccountId(), vm.isDisplayVm(), new Long(offering.getCpu()), new Long(offering.getRamSize()));\n                }\n\n                \r\n                UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE, vm.getAccountId(), vm.getDataCenterId(), vm.getId(),\n                        vm.getHostName(), vm.getServiceOfferingId(), vm.getTemplateId(), vm.getHypervisorType().toString(),\n                        VirtualMachine.class.getName(), vm.getUuid(), vm.isDisplayVm());\n            }\n        });\n\n        VirtualMachine vmoi = _itMgr.findById(vm.getId());\n        VirtualMachineProfileImpl vmOldProfile = new VirtualMachineProfileImpl(vmoi);\n\n        \r\n        List<Long> networkIdList = cmd.getNetworkIds();\n        List<Long> securityGroupIdList = cmd.getSecurityGroupIdList();\n\n        if (zone.getNetworkType() == NetworkType.Basic) {\n            if (networkIdList != null && !networkIdList.isEmpty()) {\n                throw new InvalidParameterValueException(\"Can't move vm with network Ids; this is a basic zone VM\");\n            }\n            \r\n            _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n            \r\n            _networkMgr.cleanupNics(vmOldProfile);\n            _networkMgr.removeNics(vmOldProfile);\n            \r\n            \r\n            List<NetworkVO> networkList = new ArrayList<NetworkVO>();\n\n            \r\n            Network defaultNetwork = _networkModel.getExclusiveGuestNetwork(zone.getId());\n\n            if (defaultNetwork == null) {\n                throw new InvalidParameterValueException(\"Unable to find a default network to start a vm\");\n            } else {\n                networkList.add(_networkDao.findById(defaultNetwork.getId()));\n            }\n\n            boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n\n            if (securityGroupIdList != null && isVmWare) {\n                throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n            } else if (!isVmWare && _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork) && _networkModel.canAddDefaultSecurityGroup()) {\n                if (securityGroupIdList == null) {\n                    securityGroupIdList = new ArrayList<Long>();\n                }\n                SecurityGroup defaultGroup = _securityGroupMgr.getDefaultSecurityGroup(newAccount.getId());\n                if (defaultGroup != null) {\n                    \r\n                    \r\n                    boolean defaultGroupPresent = false;\n                    for (Long securityGroupId : securityGroupIdList) {\n                        if (securityGroupId.longValue() == defaultGroup.getId()) {\n                            defaultGroupPresent = true;\n                            break;\n                        }\n                    }\n\n                    if (!defaultGroupPresent) {\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n\n                } else {\n                    \r\n                    if (s_logger.isDebugEnabled()) {\n                        s_logger.debug(\"Couldn't find default security group for the account \" + newAccount + \" so creating a new one\");\n                    }\n                    defaultGroup = _securityGroupMgr.createSecurityGroup(SecurityGroupManager.DEFAULT_GROUP_NAME, SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                            newAccount.getDomainId(), newAccount.getId(), newAccount.getAccountName());\n                    securityGroupIdList.add(defaultGroup.getId());\n                }\n            }\n\n            LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n            NicProfile profile = new NicProfile();\n            profile.setDefaultNic(true);\n            networks.put(networkList.get(0), new ArrayList<NicProfile>(Arrays.asList(profile)));\n\n            VirtualMachine vmi = _itMgr.findById(vm.getId());\n            VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n            _networkMgr.allocate(vmProfile, networks, null);\n\n            _securityGroupMgr.addInstanceToGroups(vm.getId(), securityGroupIdList);\n\n            s_logger.debug(\"AssignVM: Basic zone, adding security groups no \" + securityGroupIdList.size() + \" to \" + vm.getInstanceName());\n        } else {\n            Set<NetworkVO> applicableNetworks = new LinkedHashSet<>();\n            Map<Long, String> requestedIPv4ForNics = new HashMap<>();\n            Map<Long, String> requestedIPv6ForNics = new HashMap<>();\n            if (zone.isSecurityGroupEnabled())  { \r\n                \r\n                _securityGroupMgr.removeInstanceFromGroups(cmd.getVmId());\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\n                                    \"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                NetworkVO defaultNetwork = null;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        defaultNetwork = appNet;\n                        toggle++;\n                    }\n\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n\n                }\n\n                boolean isVmWare = (template.getHypervisorType() == HypervisorType.VMware);\n                if (securityGroupIdList != null && isVmWare) {\n                    throw new InvalidParameterValueException(\"Security group feature is not supported for vmWare hypervisor\");\n                } else if (!isVmWare && (defaultNetwork == null || _networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork)) && _networkModel.canAddDefaultSecurityGroup()) {\n                    if (securityGroupIdList == null) {\n                        securityGroupIdList = new ArrayList<Long>();\n                    }\n                    SecurityGroup defaultGroup = _securityGroupMgr\n                            .getDefaultSecurityGroup(newAccount.getId());\n                    if (defaultGroup != null) {\n                        \r\n                        \r\n                        boolean defaultGroupPresent = false;\n                        for (Long securityGroupId : securityGroupIdList) {\n                            if (securityGroupId.longValue() == defaultGroup.getId()) {\n                                defaultGroupPresent = true;\n                                break;\n                            }\n                        }\n\n                        if (!defaultGroupPresent) {\n                            securityGroupIdList.add(defaultGroup.getId());\n                        }\n\n                    } else {\n                        \r\n                        if (s_logger.isDebugEnabled()) {\n                            s_logger.debug(\"Couldn't find default security group for the account \"\n                                    + newAccount + \" so creating a new one\");\n                        }\n                        defaultGroup = _securityGroupMgr.createSecurityGroup(\n                                SecurityGroupManager.DEFAULT_GROUP_NAME,\n                                SecurityGroupManager.DEFAULT_GROUP_DESCRIPTION,\n                                newAccount.getDomainId(), newAccount.getId(),\n                                newAccount.getAccountName());\n                        securityGroupIdList.add(defaultGroup.getId());\n                    }\n                }\n\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n\n                if (applicableNetworks.isEmpty()) {\n                    throw new InvalidParameterValueException(\"No network is specified, please specify one when you move the vm. For now, please add a network to VM on NICs tab.\");\n                } else {\n                    _networkMgr.allocate(vmProfile, networks, null);\n                }\n\n                _securityGroupMgr.addInstanceToGroups(vm.getId(),\n                        securityGroupIdList);\n                s_logger.debug(\"AssignVM: Advanced zone, adding security groups no \"\n                        + securityGroupIdList.size() + \" to \"\n                        + vm.getInstanceName());\n\n            } else {\n                if (securityGroupIdList != null && !securityGroupIdList.isEmpty()) {\n                    throw new InvalidParameterValueException(\"Can't move vm with security groups; security group feature is not enabled in this zone\");\n                }\n                \r\n                if (networkIdList == null || networkIdList.isEmpty()) {\n                    NicVO defaultNicOld = _nicDao.findDefaultNicForVM(vm.getId());\n                    if (defaultNicOld != null) {\n                        NetworkVO defaultNetworkOld = _networkDao.findById(defaultNicOld.getNetworkId());\n                        if (canAccountUseNetwork(newAccount, defaultNetworkOld)) {\n                            applicableNetworks.add(defaultNetworkOld);\n                            requestedIPv4ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv4Address());\n                            requestedIPv6ForNics.put(defaultNetworkOld.getId(), defaultNicOld.getIPv6Address());\n                            s_logger.debug(\"AssignVM: use old shared network \" + defaultNetworkOld.getName() + \" with old ip \" + defaultNicOld.getIPv4Address() + \" on default nic of vm:\" + vm.getInstanceName());\n                        }\n                    }\n                }\n\n                if (networkIdList != null && !networkIdList.isEmpty()) {\n                    \r\n                    for (Long networkId : networkIdList) {\n                        NetworkVO network = _networkDao.findById(networkId);\n                        if (network == null) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Unable to find specified network id\");\n                            ex.addProxyObject(networkId.toString(), \"networkId\");\n                            throw ex;\n                        }\n\n                        _networkModel.checkNetworkPermissions(newAccount, network);\n\n                        \r\n                        NetworkOffering networkOffering = _entityMgr.findById(NetworkOffering.class, network.getNetworkOfferingId());\n                        if (networkOffering.isSystemOnly()) {\n                            InvalidParameterValueException ex = new InvalidParameterValueException(\"Specified Network id is system only and can't be used for vm deployment\");\n                            ex.addProxyObject(network.getUuid(), \"networkId\");\n                            throw ex;\n                        }\n\n                        if (network.getGuestType() == Network.GuestType.Shared && network.getAclType() == ACLType.Domain) {\n                            NicVO nicOld = _nicDao.findByNtwkIdAndInstanceId(network.getId(), vm.getId());\n                            if (nicOld != null) {\n                                requestedIPv4ForNics.put(network.getId(), nicOld.getIPv4Address());\n                                requestedIPv6ForNics.put(network.getId(), nicOld.getIPv6Address());\n                                s_logger.debug(\"AssignVM: use old shared network \" + network.getName() + \" with old ip \" + nicOld.getIPv4Address() + \" on nic of vm:\" + vm.getInstanceName());\n                            }\n                        }\n                        s_logger.debug(\"AssignVM: Added network \" + network.getName() + \" to vm \" + vm.getId());\n                        applicableNetworks.add(network);\n                    }\n                } else if (applicableNetworks.isEmpty()) {\n                    NetworkVO defaultNetwork = null;\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new InvalidParameterValueException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as a part of vm creation\");\n                    }\n                    if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                        \r\n                        List<? extends Network> virtualNetworks = _networkModel.listNetworksForAccount(newAccount.getId(), zone.getId(), Network.GuestType.Isolated);\n                        if (virtualNetworks.isEmpty()) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zone.getId(), requiredOfferings.get(0).getTags(), requiredOfferings.get(0)\n                                    .getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n                            s_logger.debug(\"Creating network for account \" + newAccount + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of deployVM process\");\n                            Network newNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), newAccount.getAccountName() + \"-network\",\n                                    newAccount.getAccountName() + \"-network\", null, null, null, false, null, newAccount,\n                                    null, physicalNetwork, zone.getId(), ACLType.Account, null, null,\n                                    null, null, true, null, null, null, null, null);\n                            \r\n                            if (requiredOfferings.get(0).isPersistent()) {\n                                DeployDestination dest = new DeployDestination(zone, null, null, null);\n                                UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n                                Journal journal = new Journal.LogJournal(\"Implementing \" + newNetwork, s_logger);\n                                ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, caller);\n                                s_logger.debug(\"Implementing the network for account\" + newNetwork + \" as a part of\" + \" network provision for persistent networks\");\n                                try {\n                                    Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(newNetwork.getId(), dest, context);\n                                    if (implementedNetwork == null || implementedNetwork.first() == null) {\n                                        s_logger.warn(\"Failed to implement the network \" + newNetwork);\n                                    }\n                                    newNetwork = implementedNetwork.second();\n                                } catch (Exception ex) {\n                                    s_logger.warn(\"Failed to implement network \" + newNetwork + \" elements and\"\n                                            + \" resources as a part of network provision for persistent network due to \", ex);\n                                    CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network\"\n                                            + \" (with specified id) elements and resources as a part of network provision\");\n                                    e.addProxyObject(newNetwork.getUuid(), \"networkId\");\n                                    throw e;\n                                }\n                            }\n                            defaultNetwork = _networkDao.findById(newNetwork.getId());\n                        } else if (virtualNetworks.size() > 1) {\n                            throw new InvalidParameterValueException(\"More than 1 default Isolated networks are found \" + \"for account \" + newAccount\n                                    + \"; please specify networkIds\");\n                        } else {\n                            defaultNetwork = _networkDao.findById(virtualNetworks.get(0).getId());\n                        }\n                    } else {\n                        throw new InvalidParameterValueException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                    }\n\n                    applicableNetworks.add(defaultNetwork);\n                }\n\n                \r\n                _networkMgr.cleanupNics(vmOldProfile);\n                _networkMgr.removeNics(vmOldProfile);\n\n                \r\n                LinkedHashMap<Network, List<? extends NicProfile>> networks = new LinkedHashMap<Network, List<? extends NicProfile>>();\n                int toggle = 0;\n                for (NetworkVO appNet : applicableNetworks) {\n                    NicProfile defaultNic = new NicProfile();\n                    if (toggle == 0) {\n                        defaultNic.setDefaultNic(true);\n                        toggle++;\n                    }\n                    defaultNic.setRequestedIPv4(requestedIPv4ForNics.get(appNet.getId()));\n                    defaultNic.setRequestedIPv6(requestedIPv6ForNics.get(appNet.getId()));\n                    networks.put(appNet, new ArrayList<NicProfile>(Arrays.asList(defaultNic)));\n                }\n                VirtualMachine vmi = _itMgr.findById(vm.getId());\n                VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmi);\n                _networkMgr.allocate(vmProfile, networks, null);\n                s_logger.debug(\"AssignVM: Advance virtual, adding networks no \" + networks.size() + \" to \" + vm.getInstanceName());\n            } \r\n        } \r\n        s_logger.info(\"AssignVM: vm \" + vm.getInstanceName() + \" now belongs to account \" + newAccount.getAccountName());\n        return vm;\n    }\n","realPath":"server/src/main/java/com/cloud/vm/UserVmManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":6628,"status":"M"},{"authorDate":"2021-02-18 16:24:09","commitOrder":9,"curCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null, null, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","date":"2021-02-18 16:24:09","endLine":1818,"groupId":"101355","id":18,"instanceNumber":2,"isCurCommit":0,"methodName":"associateIpAddressListToAccount","params":"(longuserId@finallongaccountId@finallongzoneId@finalLongvlanId@finalNetworkguestNetworkFinal)","path":"/mnt/clonedata/CloneManagementServer/ManagementServer/consistResult/result-cloudstack-10-0.7/blobInfo/CC_OUT/blobs/51/af56a887a20dd4a8ab1b428a978173356acec0.src","preCode":"    public boolean associateIpAddressListToAccount(long userId, final long accountId, final long zoneId, final Long vlanId, final Network guestNetworkFinal)\n            throws InsufficientCapacityException, ConcurrentOperationException, ResourceUnavailableException, ResourceAllocationException {\n        final Account owner = _accountMgr.getActiveAccountById(accountId);\n\n        if (guestNetworkFinal != null && guestNetworkFinal.getTrafficType() != TrafficType.Guest) {\n            throw new InvalidParameterValueException(\"Network \" + guestNetworkFinal + \" is not of a type \" + TrafficType.Guest);\n        }\n\n        Ternary<Boolean, List<NetworkOfferingVO>, Network> pair = null;\n        try {\n            pair = Transaction.execute(new TransactionCallbackWithException<Ternary<Boolean, List<NetworkOfferingVO>, Network>, Exception>() {\n                @Override\n                public Ternary<Boolean, List<NetworkOfferingVO>, Network> doInTransaction(TransactionStatus status) throws InsufficientCapacityException,\n                        ResourceAllocationException {\n                    boolean createNetwork = false;\n                    Network guestNetwork = guestNetworkFinal;\n\n                    if (guestNetwork == null) {\n                        List<? extends Network> networks = getIsolatedNetworksWithSourceNATOwnedByAccountInZone(zoneId, owner);\n                        if (networks.size() == 0) {\n                            createNetwork = true;\n                        } else if (networks.size() == 1) {\n                            guestNetwork = networks.get(0);\n                        } else {\n                            throw new InvalidParameterValueException(\"Error, more than 1 Guest Isolated Networks with SourceNAT \"\n                                    + \"service enabled found for this account, cannot assosiate the IP range, please provide the network ID\");\n                        }\n                    }\n\n                    \r\n                    List<NetworkOfferingVO> requiredOfferings = _networkOfferingDao.listByAvailability(Availability.Required, false);\n                    if (requiredOfferings.size() < 1) {\n                        throw new CloudRuntimeException(\"Unable to find network offering with availability=\" + Availability.Required\n                                + \" to automatically create the network as part of createVlanIpRange\");\n                    }\n                    if (createNetwork) {\n                        if (requiredOfferings.get(0).getState() == NetworkOffering.State.Enabled) {\n                            long physicalNetworkId = _networkModel.findPhysicalNetworkId(zoneId, requiredOfferings.get(0).getTags(), requiredOfferings.get(0).getTrafficType());\n                            \r\n                            PhysicalNetwork physicalNetwork = _physicalNetworkDao.findById(physicalNetworkId);\n                            if (physicalNetwork == null) {\n                                throw new InvalidParameterValueException(\"Unable to find physical network with id: \" + physicalNetworkId + \" and tag: \"\n                                        + requiredOfferings.get(0).getTags());\n                            }\n\n                            s_logger.debug(\"Creating network for account \" + owner + \" from the network offering id=\" + requiredOfferings.get(0).getId()\n                                    + \" as a part of createVlanIpRange process\");\n                            guestNetwork = _networkMgr.createGuestNetwork(requiredOfferings.get(0).getId(), owner.getAccountName() + \"-network\", owner.getAccountName()\n                                    + \"-network\", null, null, null, false, null, owner, null, physicalNetwork, zoneId, ACLType.Account, null, null, null, null, true, null, null, null, null, null);\n                            if (guestNetwork == null) {\n                                s_logger.warn(\"Failed to create default Virtual network for the account \" + accountId + \"in zone \" + zoneId);\n                                throw new CloudRuntimeException(\"Failed to create a Guest Isolated Networks with SourceNAT \"\n                                        + \"service enabled as a part of createVlanIpRange, for the account \" + accountId + \"in zone \" + zoneId);\n                            }\n                        } else {\n                            throw new CloudRuntimeException(\"Required network offering id=\" + requiredOfferings.get(0).getId() + \" is not in \" + NetworkOffering.State.Enabled);\n                        }\n                    }\n\n                    \r\n                    boolean allocateSourceNat = false;\n                    List<IPAddressVO> sourceNat = _ipAddressDao.listByAssociatedNetwork(guestNetwork.getId(), true);\n                    if (sourceNat.isEmpty()) {\n                        allocateSourceNat = true;\n                    }\n\n                    \r\n                    List<IPAddressVO> ips = _ipAddressDao.listByVlanId(vlanId);\n                    boolean isSourceNatAllocated = false;\n                    for (IPAddressVO addr : ips) {\n                        if (addr.getState() != State.Allocated) {\n                            if (!isSourceNatAllocated && allocateSourceNat) {\n                                addr.setSourceNat(true);\n                                isSourceNatAllocated = true;\n                            } else {\n                                addr.setSourceNat(false);\n                            }\n                            addr.setAssociatedWithNetworkId(guestNetwork.getId());\n                            addr.setVpcId(guestNetwork.getVpcId());\n                            addr.setAllocatedTime(new Date());\n                            addr.setAllocatedInDomainId(owner.getDomainId());\n                            addr.setAllocatedToAccountId(owner.getId());\n                            addr.setSystem(false);\n                            addr.setState(IpAddress.State.Allocating);\n                            markPublicIpAsAllocated(addr);\n                        }\n                    }\n                    return new Ternary<Boolean, List<NetworkOfferingVO>, Network>(createNetwork, requiredOfferings, guestNetwork);\n                }\n            });\n        } catch (Exception e1) {\n            ExceptionUtil.rethrowRuntime(e1);\n            ExceptionUtil.rethrow(e1, InsufficientCapacityException.class);\n            ExceptionUtil.rethrow(e1, ResourceAllocationException.class);\n            throw new IllegalStateException(e1);\n        }\n\n        boolean createNetwork = pair.first();\n        List<NetworkOfferingVO> requiredOfferings = pair.second();\n        Network guestNetwork = pair.third();\n\n        \r\n        if (createNetwork && requiredOfferings.get(0).isPersistent()) {\n            DataCenter zone = _dcDao.findById(zoneId);\n            DeployDestination dest = new DeployDestination(zone, null, null, null);\n            Account callerAccount = CallContext.current().getCallingAccount();\n            UserVO callerUser = _userDao.findById(CallContext.current().getCallingUserId());\n            Journal journal = new Journal.LogJournal(\"Implementing \" + guestNetwork, s_logger);\n            ReservationContext context = new ReservationContextImpl(UUID.randomUUID().toString(), journal, callerUser, callerAccount);\n            s_logger.debug(\"Implementing network \" + guestNetwork + \" as a part of network provision for persistent network\");\n            try {\n                Pair<? extends NetworkGuru, ? extends Network> implementedNetwork = _networkMgr.implementNetwork(guestNetwork.getId(), dest, context);\n                if (implementedNetwork == null || implementedNetwork.first() == null) {\n                    s_logger.warn(\"Failed to implement the network \" + guestNetwork);\n                }\n                if (implementedNetwork != null) {\n                    guestNetwork = implementedNetwork.second();\n                }\n            } catch (Exception ex) {\n                s_logger.warn(\"Failed to implement network \" + guestNetwork + \" elements and resources as a part of\" + \" network provision due to \", ex);\n                CloudRuntimeException e = new CloudRuntimeException(\"Failed to implement network (with specified id)\"\n                        + \" elements and resources as a part of network provision for persistent network\");\n                e.addProxyObject(guestNetwork.getUuid(), \"networkId\");\n                throw e;\n            }\n        }\n        return true;\n    }\n","realPath":"server/src/main/java/com/cloud/network/IpAddressManagerImpl.java","repoName":"cloudstack","snippetEndLine":0,"snippetStartLine":0,"startLine":1691,"status":"N"}],"commitId":"74bb80687d4cea1288a964d12b43108117cb5744","commitMessage":"@@@resource limit: Fix resource limit check on VM start (#5428)\n\n* resource limit: Fix resource limit check on VM start\n\n* add check to validate if cpu/memory are within limits for custom offering + exception handling\n\n* unit tests\n\nCo-authored-by: utchoang <hoangnm@unitech.vn>","date":"2021-09-24 12:21:16","modifiedFileCount":"6","status":"M","submitter":"Pearl Dsilva"}]
